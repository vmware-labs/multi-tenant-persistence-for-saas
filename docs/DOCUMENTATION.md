<!-- Code generated by gomarkdoc. DO NOT EDIT -->

[![Go Report Card](https://goreportcard.com/badge/github.com/vmware-labs/multi-tenant-persistence-for-saas)](https://goreportcard.com/report/github.com/vmware-labs/multi-tenant-persistence-for-saas)
[![GitHub Actions](https://github.com/vmware-labs/multi-tenant-persistence-for-saas/actions/workflows/go.yml/badge.svg)](https://github.com/vmware-labs/multi-tenant-persistence-for-saas/actions?query=branch%3Amaster)
[![Go Reference](https://pkg.go.dev/badge/github.com/vmware-labs/multi-tenant-persistence-for-saas/)](https://pkg.go.dev/github.com/vmware-labs/multi-tenant-persistence-for-saas)
[![Code Coverage](https://codecov.io/gh/vmware-labs/multi-tenant-persistence-for-saas/branch/main/graph/badge.svg?token=F7TQPSFEMCN)](https://app.codecov.io/gh/vmware-labs/multi-tenant-persistence-for-saas)


# authorizer

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/authorizer"
```

## Index

- [Constants](<#constants>)
- [type Authorizer](<#Authorizer>)
- [type ContextKey](<#ContextKey>)
- [type Instancer](<#Instancer>)
- [type MetadataBasedAuthorizer](<#MetadataBasedAuthorizer>)
  - [func \(s MetadataBasedAuthorizer\) Configure\(\_ string, \_ map\[string\]dbrole.DbRole\)](<#MetadataBasedAuthorizer.Configure>)
  - [func \(s MetadataBasedAuthorizer\) GetAuthContext\(orgId string, roles ...string\) context.Context](<#MetadataBasedAuthorizer.GetAuthContext>)
  - [func \(s MetadataBasedAuthorizer\) GetDefaultOrgAdminContext\(\) context.Context](<#MetadataBasedAuthorizer.GetDefaultOrgAdminContext>)
  - [func \(s MetadataBasedAuthorizer\) GetMatchingDbRole\(ctx context.Context, \_ ...string\) \(dbrole.DbRole, error\)](<#MetadataBasedAuthorizer.GetMatchingDbRole>)
  - [func \(s MetadataBasedAuthorizer\) GetOrgFromContext\(ctx context.Context\) \(string, error\)](<#MetadataBasedAuthorizer.GetOrgFromContext>)
- [type SimpleInstancer](<#SimpleInstancer>)
  - [func \(s SimpleInstancer\) GetInstanceId\(ctx context.Context\) \(string, error\)](<#SimpleInstancer.GetInstanceId>)
  - [func \(s SimpleInstancer\) WithInstanceId\(ctx context.Context, instanceId string\) context.Context](<#SimpleInstancer.WithInstanceId>)
- [type SimpleTransactionFetcher](<#SimpleTransactionFetcher>)
  - [func \(s SimpleTransactionFetcher\) GetTransactionCtx\(ctx context.Context\) \*gorm.DB](<#SimpleTransactionFetcher.GetTransactionCtx>)
  - [func \(s SimpleTransactionFetcher\) IsTransactionCtx\(ctx context.Context\) bool](<#SimpleTransactionFetcher.IsTransactionCtx>)
  - [func \(s SimpleTransactionFetcher\) WithTransactionCtx\(ctx context.Context, tx \*gorm.DB\) context.Context](<#SimpleTransactionFetcher.WithTransactionCtx>)
- [type Tenancer](<#Tenancer>)
- [type TransactionContextKey](<#TransactionContextKey>)
- [type TransactionFetcher](<#TransactionFetcher>)


## Constants

<a name="GLOBAL_DEFAULT_ORG_ID"></a>

```go
const (
    GLOBAL_DEFAULT_ORG_ID = "_GlobalDefaultOrg"

    METADATA_KEY_ORGID            = "orgid"
    METADATA_KEY_ROLE             = "role"
    METADATA_ROLE_SERVICE_ADMIN   = "service_admin"
    METADATA_ROLE_SERVICE_AUDITOR = "service_auditor"
    METADATA_ROLE_ADMIN           = "admin"   // can be tenant_admin, *_admin
    METADATA_ROLE_AUDITOR         = "auditor" // can be tenant_auditor, *_auditor
)
```

<a name="INSTANCE_ID"></a>

```go
const (
    INSTANCE_ID = ContextKey("multiinstance.id")
)
```

<a name="TransactionCtx"></a>

```go
const (
    TransactionCtx = TransactionContextKey("DB_TRANSACTION")
)
```

<a name="Authorizer"></a>
## type [Authorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/authorizer.go#L30-L36>)

Authorizer Interface defines the methods required for datastore to restrict access based on roles configured in context.

```go
type Authorizer interface {
    Tenancer
    Configure(tableName string, roleMapping map[string]dbrole.DbRole)
    GetAuthContext(orgId string, roles ...string) context.Context
    GetDefaultOrgAdminContext() context.Context
    GetMatchingDbRole(ctx context.Context, tableNames ...string) (dbrole.DbRole, error)
}
```

<a name="ContextKey"></a>
## type [ContextKey](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/instancer.go#L10>)



```go
type ContextKey string
```

<a name="Instancer"></a>
## type [Instancer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/instancer.go#L16-L19>)



```go
type Instancer interface {
    GetInstanceId(ctx context.Context) (string, error)
    WithInstanceId(ctx context.Context, instanceId string) context.Context
}
```

<a name="MetadataBasedAuthorizer"></a>
## type [MetadataBasedAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L42>)



```go
type MetadataBasedAuthorizer struct{}
```

<a name="MetadataBasedAuthorizer.Configure"></a>
### func \(MetadataBasedAuthorizer\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L80>)

```go
func (s MetadataBasedAuthorizer) Configure(_ string, _ map[string]dbrole.DbRole)
```



<a name="MetadataBasedAuthorizer.GetAuthContext"></a>
### func \(MetadataBasedAuthorizer\) [GetAuthContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L85>)

```go
func (s MetadataBasedAuthorizer) GetAuthContext(orgId string, roles ...string) context.Context
```



<a name="MetadataBasedAuthorizer.GetDefaultOrgAdminContext"></a>
### func \(MetadataBasedAuthorizer\) [GetDefaultOrgAdminContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L89>)

```go
func (s MetadataBasedAuthorizer) GetDefaultOrgAdminContext() context.Context
```



<a name="MetadataBasedAuthorizer.GetMatchingDbRole"></a>
### func \(MetadataBasedAuthorizer\) [GetMatchingDbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L58>)

```go
func (s MetadataBasedAuthorizer) GetMatchingDbRole(ctx context.Context, _ ...string) (dbrole.DbRole, error)
```



<a name="MetadataBasedAuthorizer.GetOrgFromContext"></a>
### func \(MetadataBasedAuthorizer\) [GetOrgFromContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L44>)

```go
func (s MetadataBasedAuthorizer) GetOrgFromContext(ctx context.Context) (string, error)
```



<a name="SimpleInstancer"></a>
## type [SimpleInstancer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/instancer.go#L21>)



```go
type SimpleInstancer struct{}
```

<a name="SimpleInstancer.GetInstanceId"></a>
### func \(SimpleInstancer\) [GetInstanceId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/instancer.go#L23>)

```go
func (s SimpleInstancer) GetInstanceId(ctx context.Context) (string, error)
```



<a name="SimpleInstancer.WithInstanceId"></a>
### func \(SimpleInstancer\) [WithInstanceId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/instancer.go#L30>)

```go
func (s SimpleInstancer) WithInstanceId(ctx context.Context, instanceId string) context.Context
```



<a name="SimpleTransactionFetcher"></a>
## type [SimpleTransactionFetcher](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/transaction.go#L21>)



```go
type SimpleTransactionFetcher struct{}
```

<a name="SimpleTransactionFetcher.GetTransactionCtx"></a>
### func \(SimpleTransactionFetcher\) [GetTransactionCtx](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/transaction.go#L23>)

```go
func (s SimpleTransactionFetcher) GetTransactionCtx(ctx context.Context) *gorm.DB
```



<a name="SimpleTransactionFetcher.IsTransactionCtx"></a>
### func \(SimpleTransactionFetcher\) [IsTransactionCtx](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/transaction.go#L36>)

```go
func (s SimpleTransactionFetcher) IsTransactionCtx(ctx context.Context) bool
```



<a name="SimpleTransactionFetcher.WithTransactionCtx"></a>
### func \(SimpleTransactionFetcher\) [WithTransactionCtx](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/transaction.go#L32>)

```go
func (s SimpleTransactionFetcher) WithTransactionCtx(ctx context.Context, tx *gorm.DB) context.Context
```



<a name="Tenancer"></a>
## type [Tenancer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/authorizer.go#L38-L40>)



```go
type Tenancer interface {
    GetOrgFromContext(ctx context.Context) (string, error)
}
```

<a name="TransactionContextKey"></a>
## type [TransactionContextKey](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/transaction.go#L9>)



```go
type TransactionContextKey string
```

<a name="TransactionFetcher"></a>
## type [TransactionFetcher](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/transaction.go#L15-L19>)



```go
type TransactionFetcher interface {
    IsTransactionCtx(ctx context.Context) bool
    GetTransactionCtx(ctx context.Context) *gorm.DB
    WithTransactionCtx(ctx context.Context, tx *gorm.DB) context.Context
}
```

# datastore

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/datastore"
```

Import the package and use [DataStore](<#DataStore>) interface to interact with the data access layer. If you want DAL to use a Postgres database, ensure you have the following environment variables set to relevant values: \[DB\_ADMIN\_USERNAME\], \[DB\_PORT\], \[DB\_NAME\], \[DB\_ADMIN\_PASSWORD\], \[DB\_HOST\], \[SSL\_MODE\]. You can also set \[LOG\_LEVEL\] environment variable to debug/trace, if you want logging at a specific level \(default is \[Info\]\)

Define structs that will be persisted using datastore similar to any gorm Models, for reference https://gorm.io/docs/models.html

- At least one field must be a primary key with \`gorm:"primaryKey"\` tag
- For multi\-tenancy support, add \`gorm:"column:org\_id"\` as tag to a filed
- For revision support to block concurrent updates, add \`gorm:"column:revision"\` as tag
- For multi\-instance support, add \`gorm:"column:instance\_id"\` as tag

DataStore interface exposes basic methods like Find/FindAll/Upsert/Delete. For richer queries and performing a set of operations within a transaction, please, use GetTransaction\(\) method. For more info, refer to Gorm's transactions page: https://gorm.io/docs/transactions.html

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func DBCreate\(cfg DBConfig\) error](<#DBCreate>)
- [func DBExists\(cfg DBConfig\) bool](<#DBExists>)
- [func GetCompLogger\(\) \*logrus.Entry](<#GetCompLogger>)
- [func GetFieldValue\(record Record, fieldName, columnName string\) \(string, bool\)](<#GetFieldValue>)
- [func GetGormLogger\(l \*logrus.Entry\) logger.Interface](<#GetGormLogger>)
- [func GetInstanceId\(record Record\) \(string, bool\)](<#GetInstanceId>)
- [func GetLogLevel\(\) string](<#GetLogLevel>)
- [func GetLogger\(\) \*logrus.Logger](<#GetLogger>)
- [func GetOrgId\(record Record\) \(string, bool\)](<#GetOrgId>)
- [func GetTableName\(x interface\{\}\) \(tableName string\)](<#GetTableName>)
- [func IsColumnPresent\(x Record, tableName, columnName string\) bool](<#IsColumnPresent>)
- [func IsMultiInstanced\(x Record, tableName string, instancerConfigured bool\) bool](<#IsMultiInstanced>)
- [func IsMultiTenanted\(x Record, tableName string\) bool](<#IsMultiTenanted>)
- [func IsPointerToStruct\(x interface\{\}\) \(isPtrType bool\)](<#IsPointerToStruct>)
- [func IsRevisioned\(x Record, tableName string\) bool](<#IsRevisioned>)
- [func IsRowLevelSecurityRequired\(record Record, tableName string, instancerConfigured bool\) bool](<#IsRowLevelSecurityRequired>)
- [func SetFieldValue\(record Record, fieldName, columnName, value string\) bool](<#SetFieldValue>)
- [func SetInstanceId\(record Record, value string\) bool](<#SetInstanceId>)
- [func TypeName\(x interface\{\}\) string](<#TypeName>)
- [type DBConfig](<#DBConfig>)
  - [func ConfigFromEnv\(dbName string\) DBConfig](<#ConfigFromEnv>)
- [type DataStore](<#DataStore>)
  - [func FromConfig\(l \*logrus.Entry, a authorizer.Authorizer, instancer authorizer.Instancer, cfg DBConfig\) \(d DataStore, err error\)](<#FromConfig>)
  - [func FromEnv\(l \*logrus.Entry, a authorizer.Authorizer, instancer authorizer.Instancer\) \(d DataStore, err error\)](<#FromEnv>)
  - [func FromEnvWithDB\(l \*logrus.Entry, a authorizer.Authorizer, instancer authorizer.Instancer, dbName string\) \(d DataStore, err error\)](<#FromEnvWithDB>)
- [type Helper](<#Helper>)
- [type Pagination](<#Pagination>)
  - [func DefaultPagination\(\) \*Pagination](<#DefaultPagination>)
  - [func GetPagination\(offset int, limit int, sortBy string\) \*Pagination](<#GetPagination>)
  - [func NoPagination\(\) \*Pagination](<#NoPagination>)
- [type Record](<#Record>)
  - [func GetRecordInstanceFromSlice\(x interface\{\}\) Record](<#GetRecordInstanceFromSlice>)
- [type TenancyInfo](<#TenancyInfo>)
- [type TestHelper](<#TestHelper>)


## Constants

<a name="DbConfigOrgId"></a>

```go
const (
    DbConfigOrgId      = "multitenant.orgId"      // Name of Postgres run-time config. parameter that will store current user's org. ID
    DbConfigInstanceId = "multitenant.instanceId" // Name of Postgres run-time config. parameter that will store current session's instance ID

    MaxIdleConns = 1
)
```

<a name="DB_NAME_ENV_VAR"></a>

```go
const (
    // Env. variable names.
    DB_NAME_ENV_VAR           = "DB_NAME"
    DB_PORT_ENV_VAR           = "DB_PORT"
    DB_HOST_ENV_VAR           = "DB_HOST"
    SSL_MODE_ENV_VAR          = "SSL_MODE"
    DB_ADMIN_USERNAME_ENV_VAR = "DB_ADMIN_USERNAME"
    DB_ADMIN_PASSWORD_ENV_VAR = "DB_ADMIN_PASSWORD"

    // SQL Error Codes.
    ERROR_DUPLICATE_KEY      = "SQLSTATE 23505"
    ERROR_DUPLICATE_DATABASE = "SQLSTATE 42P04"
)
```

<a name="LOG_LEVEL_ENV_VAR"></a>

```go
const (
    // Logging configuration variables.
    LOG_LEVEL_ENV_VAR = "LOG_LEVEL"

    // Constants for LOG field names & values.
    COMP             = "comp"
    SAAS_PERSISTENCE = "persistence"
)
```

<a name="DEFAULT_OFFSET"></a>

```go
const (
    DEFAULT_OFFSET = 0
    DEFAULT_LIMIT  = 1000
    DEFAULT_SORTBY = ""
)
```

<a name="FIELD_ORGID"></a>

```go
const (
    // Struct Field Names.
    FIELD_ORGID      = "OrgId"
    FIELD_INSTANCEID = "InstanceId"

    // SQL Columns.
    COLUMN_ORGID      = "org_id"
    COLUMN_INSTANCEID = "instance_id"
    COLUMN_REVISION   = "revision"

    // Messages.
    REVISION_OUTDATED_MSG = "Invalid update - outdated "
)
```

## Variables

<a name="TRACE"></a>

```go
var TRACE = func(format string, v ...any) {
}
```

<a name="DBCreate"></a>
## func [DBCreate](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L231>)

```go
func DBCreate(cfg DBConfig) error
```

Create a Postgres DB using the provided config if it doesn't exist.

<a name="DBExists"></a>
## func [DBExists](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L253>)

```go
func DBExists(cfg DBConfig) bool
```

Checks if a Postgres DB exists and returns true.

<a name="GetCompLogger"></a>
## func [GetCompLogger](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L79>)

```go
func GetCompLogger() *logrus.Entry
```



<a name="GetFieldValue"></a>
## func [GetFieldValue](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L399>)

```go
func GetFieldValue(record Record, fieldName, columnName string) (string, bool)
```

Returns the requested fields value from record, which is a pointer to a struct implementing Record interface. Uses a tag rather than field name to find the desired field. Returns an empty string and false if such a field is not present.

<a name="GetGormLogger"></a>
## func [GetGormLogger](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L70>)

```go
func GetGormLogger(l *logrus.Entry) logger.Interface
```



<a name="GetInstanceId"></a>
## func [GetInstanceId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L387>)

```go
func GetInstanceId(record Record) (string, bool)
```

Returns the requested InstanceId field's value from record, which is a pointer to a struct implementing Record interface. Uses a tag rather than field name to find the desired field. Returns an empty string and false if such a field is not present.

<a name="GetLogLevel"></a>
## func [GetLogLevel](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L47>)

```go
func GetLogLevel() string
```



<a name="GetLogger"></a>
## func [GetLogger](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L51>)

```go
func GetLogger() *logrus.Logger
```



<a name="GetOrgId"></a>
## func [GetOrgId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L379>)

```go
func GetOrgId(record Record) (string, bool)
```

Returns the requested OrgId field's value from record, which is a pointer to a struct implementing Record interface. Uses a tag rather than field name to find the desired field. Returns an empty string and false if such a field is not present.

<a name="GetTableName"></a>
## func [GetTableName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L238>)

```go
func GetTableName(x interface{}) (tableName string)
```

Extracts struct's name, which will serve as DB table name, using reflection.

<a name="IsColumnPresent"></a>
## func [IsColumnPresent](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L82>)

```go
func IsColumnPresent(x Record, tableName, columnName string) bool
```



<a name="IsMultiInstanced"></a>
## func [IsMultiInstanced](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L73>)

```go
func IsMultiInstanced(x Record, tableName string, instancerConfigured bool) bool
```

Checks if multiple deployment instances are supported in the given table.

<a name="IsMultiTenanted"></a>
## func [IsMultiTenanted](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L68>)

```go
func IsMultiTenanted(x Record, tableName string) bool
```

Checks if multiple tenants are supported in the given table.

<a name="IsPointerToStruct"></a>
## func [IsPointerToStruct](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L222>)

```go
func IsPointerToStruct(x interface{}) (isPtrType bool)
```



<a name="IsRevisioned"></a>
## func [IsRevisioned](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L63>)

```go
func IsRevisioned(x Record, tableName string) bool
```

Checks if revisioning is supported in the given table.

<a name="IsRowLevelSecurityRequired"></a>
## func [IsRowLevelSecurityRequired](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L78>)

```go
func IsRowLevelSecurityRequired(record Record, tableName string, instancerConfigured bool) bool
```

Row Level Security to used to partition tables for multi\-tenancy and multi\-instance support.

<a name="SetFieldValue"></a>
## func [SetFieldValue](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L420>)

```go
func SetFieldValue(record Record, fieldName, columnName, value string) bool
```



<a name="SetInstanceId"></a>
## func [SetInstanceId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L391>)

```go
func SetInstanceId(record Record, value string) bool
```



<a name="TypeName"></a>
## func [TypeName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L218>)

```go
func TypeName(x interface{}) string
```

TypeName returns name of the data type of the given variable.

<a name="DBConfig"></a>
## type [DBConfig](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L52-L59>)



```go
type DBConfig struct {
    // contains filtered or unexported fields
}
```

<a name="ConfigFromEnv"></a>
### func [ConfigFromEnv](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L64>)

```go
func ConfigFromEnv(dbName string) DBConfig
```

Returns DBConfig constructed from the env variables. If dbName is set, it is used instead of DB\_NAME env variable. All env variables are required and if not set, this method would panic.

<a name="DataStore"></a>
## type [DataStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/datastore.go#L48-L75>)



```go
type DataStore interface {
    Find(ctx context.Context, record Record) error
    FindAll(ctx context.Context, records interface{}, pagination *Pagination) error
    FindWithFilter(ctx context.Context, filter Record, records interface{}, pagination *Pagination) error
    Insert(ctx context.Context, record Record) (int64, error)
    SoftDelete(ctx context.Context, record Record) (int64, error)
    Delete(ctx context.Context, record Record) (int64, error)
    Update(ctx context.Context, record Record) (int64, error)
    Upsert(ctx context.Context, record Record) (int64, error)
    GetTransaction(ctx context.Context, record ...Record) (tx *gorm.DB, err error)

    // Create a DB table for the given struct. Enables RLS in it if it is multi-tenant.
    // Generates Postgres roles and policies based on the provided role mapping and applies them
    // to the created DB table.
    // roleMapping - maps service roles to DB roles to be used for the generated DB table
    // There are 4 possible DB roles to choose from:
    // - READER, which gives read access to all the records in the table
    // - WRITER, which gives read & write access to all the records in the table
    // - TENANT_READER, which gives read access to current tenant's records
    // - TENANT_WRITER, which gives read & write access to current tenant's records.
    Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, records ...Record) error
    Reset()

    GetAuthorizer() authorizer.Authorizer
    GetInstancer() authorizer.Instancer
    Helper() Helper
    TestHelper() TestHelper
}
```

<details><summary>Example (Multi Instance)</summary>
<p>

Example for the multi\-instance feature, illustrates one can create records for different instances and that each instance context can access the data that belongs to specific instance only.

```go
package main

import (
	"context"
	"fmt"
	"log"

	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/authorizer"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/datastore"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/dbrole"
)

type Person struct {
	Id         string `gorm:"primaryKey"`
	Name       string
	Age        int
	InstanceId string `gorm:"primaryKey"`
}

func (p Person) String() string {
	return fmt.Sprintf("[%s/%s] %s: %d", p.InstanceId, p.Id, p.Name, p.Age)
}

// Example for the multi-instance feature, illustrates one can create records for different instances
// and that each instance context can access the data that belongs to specific instance only.
func main() {
	uId := "P1337"
	p1 := &Person{uId, "Bob", 31, "Dev"}
	p2 := &Person{uId, "John", 36, "Prod"}
	p3 := &Person{"P3", "Pat", 39, "Dev"}

	SERVICE_ADMIN := "service_admin"
	SERVICE_AUDITOR := "service_auditor"
	mdAuthorizer := authorizer.MetadataBasedAuthorizer{}
	instancer := authorizer.SimpleInstancer{}

	ServiceAdminCtx := mdAuthorizer.GetAuthContext("", SERVICE_ADMIN)
	DevInstanceCtx := instancer.WithInstanceId(ServiceAdminCtx, "Dev")
	ProdInstanceCtx := instancer.WithInstanceId(ServiceAdminCtx, "Prod")

	// Initializes the Datastore using the metadata authorizer and connection details obtained from the ENV variables.
	ds, err := datastore.FromEnvWithDB(datastore.GetCompLogger(), mdAuthorizer, instancer, "ExampleDataStore_multiInstance")
	if err != nil {
		log.Fatalf("datastore initialization from env errored: %s", err)
	}

	// Registers the necessary structs with their corresponding role mappings.
	roleMapping := map[string]dbrole.DbRole{
		SERVICE_AUDITOR: dbrole.READER,
		SERVICE_ADMIN:   dbrole.WRITER,
	}
	if err = ds.Register(context.TODO(), roleMapping, &Person{}); err != nil {
		log.Fatalf("Failed to create DB tables: %+v", err)
	}

	// Inserts a record with a given Id (uId) using the context of the Dev instance.
	rowsAffected, err := ds.Insert(DevInstanceCtx, p1)
	fmt.Println(rowsAffected, err)
	// Inserts another record with the same uId using the context of the Prod instance.
	rowsAffected, err = ds.Insert(ProdInstanceCtx, p2)
	fmt.Println(rowsAffected, err)
	// Inserts a third record with a different uId using the context of the Dev instance.
	rowsAffected, err = ds.Insert(DevInstanceCtx, p3)
	fmt.Println(rowsAffected, err)

	// Finds a record using the context of the Dev instance and the specified uId.
	q1 := &Person{Id: uId}
	err = ds.Find(DevInstanceCtx, q1)
	fmt.Println(q1, err)
	// Finds a record using the context of the Prod instance and the same uId.
	q2 := &Person{Id: uId}
	err = ds.Find(ProdInstanceCtx, q2)
	fmt.Println(q2, err)
	// Finds a record using the correct context of the Dev instance.
	q3 := &Person{Id: "P3"}
	err = ds.Find(DevInstanceCtx, q3)
	fmt.Println(q3, err)
	// Attempts to find a record using the incorrect context of the Prod instance and should error out.
	q4 := &Person{Id: "P3"}
	err = ds.Find(ProdInstanceCtx, q4)
	fmt.Printf("err != nil - %t\n", err != nil)

	// Deletes a record using the context of the Dev instance and the specified uId.
	rowsAffected, err = ds.Delete(DevInstanceCtx, q1)
	fmt.Println(rowsAffected, err)
	// Deletes a record using the context of the Prod instance and the same uId.
	rowsAffected, err = ds.Delete(ProdInstanceCtx, q2)
	fmt.Println(rowsAffected, err)
	// Attempts to delete a record using an invalid context of the Prod instance, which should not affect the database.
	rowsAffected, err = ds.Delete(ProdInstanceCtx, q4)
	fmt.Println(rowsAffected, err)
	// Deletes a record using a valid context of the Dev instance.
	rowsAffected, err = ds.Delete(DevInstanceCtx, q3)
	fmt.Println(rowsAffected, err)
}
```

#### Output

```
1 <nil>
1 <nil>
1 <nil>
[Dev/P1337] Bob: 31 <nil>
[Prod/P1337] John: 36 <nil>
[Dev/P3] Pat: 39 <nil>
err != nil - true
1 <nil>
1 <nil>
0 <nil>
1 <nil>
```

</p>
</details>

<details><summary>Example (Multi Tenancy)</summary>
<p>

Example for the multi\-tenancy feature, illustrates one can create records for different tenants and that each tenant context can access the data that belongs to specific tenant only.

```go
package main

import (
	"context"
	"fmt"
	"log"

	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/authorizer"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/datastore"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/dbrole"
)

type User struct {
	Id    string `gorm:"primaryKey"`
	Name  string
	Age   int
	OrgId string `gorm:"primaryKey"`
}

func (p User) String() string {
	return fmt.Sprintf("[%s/%s] %s: %d", p.OrgId, p.Id, p.Name, p.Age)
}

// Example for the multi-tenancy feature, illustrates one can create records for different tenants
// and that each tenant context can access the data that belongs to specific tenant only.
func main() {
	uId := "P1337"
	p1 := &User{uId, "Bob", 31, "Coke"}
	p2 := &User{uId, "John", 36, "Pepsi"}
	p3 := &User{"P3", "Pat", 39, "Coke"}

	TENANT_ADMIN := "tenant_admin"
	TENANT_AUDITOR := "tenant_auditor"
	mdAuthorizer := authorizer.MetadataBasedAuthorizer{}
	CokeOrgCtx := mdAuthorizer.GetAuthContext("Coke", TENANT_ADMIN)
	PepsiOrgCtx := mdAuthorizer.GetAuthContext("Pepsi", TENANT_ADMIN)

	// Initializes the Datastore using the metadata authorizer and connection details obtained from the ENV variables.
	ds, err := datastore.FromEnvWithDB(datastore.GetCompLogger(), mdAuthorizer, nil, "ExampleDataStore_multiTenancy")
	if err != nil {
		log.Fatalf("datastore initialization from env errored: %s", err)
	}

	// Registers the necessary structs with their corresponding tenant role mappings.
	roleMapping := map[string]dbrole.DbRole{
		TENANT_AUDITOR: dbrole.TENANT_READER,
		TENANT_ADMIN:   dbrole.TENANT_WRITER,
	}
	if err = ds.Register(context.TODO(), roleMapping, &User{}); err != nil {
		log.Fatalf("Failed to create DB tables: %+v", err)
	}

	// Inserts a record with a given Id (uId) using the context of the Coke organization.
	rowsAffected, err := ds.Insert(CokeOrgCtx, p1)
	fmt.Println(rowsAffected, err)
	// Inserts another record with the same uId using the context of the Pepsi organization.
	rowsAffected, err = ds.Insert(PepsiOrgCtx, p2)
	fmt.Println(rowsAffected, err)
	// Inserts a third record with a different uId using the context of the Coke organization.
	rowsAffected, err = ds.Insert(CokeOrgCtx, p3)
	fmt.Println(rowsAffected, err)

	// Finds a record using the context of the Coke organization and the specified uId.
	q1 := &User{Id: uId}
	err = ds.Find(CokeOrgCtx, q1)
	fmt.Println(q1, err)
	// Finds a record using the context of the Pepsi organization and the same uId.
	q2 := &User{Id: uId}
	err = ds.Find(PepsiOrgCtx, q2)
	fmt.Println(q2, err)
	// Finds a record using the correct context of the Coke organization.
	q3 := &User{Id: "P3"}
	err = ds.Find(CokeOrgCtx, q3)
	fmt.Println(q3, err)
	// Attempts to find a record using the incorrect context of the Pepsi organization and should error out.
	q4 := &User{Id: "P3"}
	err = ds.Find(PepsiOrgCtx, q4)
	fmt.Printf("err != nil - %t\n", err != nil)

	// Deletes a record using the context of the Coke organization and the specified uId.
	rowsAffected, err = ds.Delete(CokeOrgCtx, q1)
	fmt.Println(rowsAffected, err)
	// Deletes a record using the context of the Pepsi organization and the same uId.
	rowsAffected, err = ds.Delete(PepsiOrgCtx, q2)
	fmt.Println(rowsAffected, err)
	// Attempts to delete a record using an invalid context of the Pepsi organization, which should not affect the database.
	rowsAffected, err = ds.Delete(PepsiOrgCtx, q4)
	fmt.Println(rowsAffected, err)
	// Deletes a record using a valid context of the Coke organization.
	rowsAffected, err = ds.Delete(CokeOrgCtx, q3)
	fmt.Println(rowsAffected, err)

}
```

#### Output

```
1 <nil>
1 <nil>
1 <nil>
[Coke/P1337] Bob: 31 <nil>
[Pepsi/P1337] John: 36 <nil>
[Coke/P3] Pat: 39 <nil>
err != nil - true
1 <nil>
1 <nil>
0 <nil>
1 <nil>
```

</p>
</details>

<a name="FromConfig"></a>
### func [FromConfig](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L115>)

```go
func FromConfig(l *logrus.Entry, a authorizer.Authorizer, instancer authorizer.Instancer, cfg DBConfig) (d DataStore, err error)
```



<a name="FromEnv"></a>
### func [FromEnv](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L102>)

```go
func FromEnv(l *logrus.Entry, a authorizer.Authorizer, instancer authorizer.Instancer) (d DataStore, err error)
```



<a name="FromEnvWithDB"></a>
### func [FromEnvWithDB](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L106>)

```go
func FromEnvWithDB(l *logrus.Entry, a authorizer.Authorizer, instancer authorizer.Instancer, dbName string) (d DataStore, err error)
```



<a name="Helper"></a>
## type [Helper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/datastore.go#L77-L83>)



```go
type Helper interface {
    FindAllInTable(ctx context.Context, tableName string, records interface{}, pagination *Pagination) error
    FindWithFilterInTable(ctx context.Context, tableName string, record Record, records interface{}, pagination *Pagination) error
    GetDBTransaction(ctx context.Context, tableName string, record Record) (tx *gorm.DB, err error)

    RegisterHelper(ctx context.Context, roleMapping map[string]dbrole.DbRole, tableName string, record Record) error
}
```

<a name="Pagination"></a>
## type [Pagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L27-L31>)



```go
type Pagination struct {
    Offset int
    Limit  int
    SortBy string
}
```

<a name="DefaultPagination"></a>
### func [DefaultPagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L41>)

```go
func DefaultPagination() *Pagination
```



<a name="GetPagination"></a>
### func [GetPagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L33>)

```go
func GetPagination(offset int, limit int, sortBy string) *Pagination
```



<a name="NoPagination"></a>
### func [NoPagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L45>)

```go
func NoPagination() *Pagination
```



<a name="Record"></a>
## type [Record](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/record.go#L23-L26>)



```go
type Record interface {
}
```

<a name="GetRecordInstanceFromSlice"></a>
### func [GetRecordInstanceFromSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/record.go#L28>)

```go
func GetRecordInstanceFromSlice(x interface{}) Record
```



<a name="TenancyInfo"></a>
## type [TenancyInfo](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/database.go#L75-L79>)



```go
type TenancyInfo struct {
    DbRole     dbrole.DbRole
    InstanceId string
    OrgId      string
}
```

<a name="TestHelper"></a>
## type [TestHelper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/datastore.go#L85-L90>)



```go
type TestHelper interface {
    DropTables(records ...Record) error                       // Drop DB tables by records
    Truncate(tableNames ...string) error                      // Truncates DB tables
    TruncateCascade(cascade bool, tableNames ...string) error // Truncates DB tables, with an option to truncate them in a cascading fashion
    HasTable(tableName string) (bool, error)                  // Checks if DB table exists
}
```

# dbrole

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/dbrole"
```

DAL uses 4 database roles/users to perform all operations,

- \`TENANT\_READER\` \- has read access to its tenant's data

- \`READER\` \- has read access to all tenants' data

- \`TENANT\_WRITER\` \- has read & write access to its tenant's data

- \`WRITER\` \- has read & write access to all tenants' data
  
  DAL allows to map a user's service role to the DB role that will be used for that user. If a user has multiple service roles which map to several DB roles, the DB role with the most extensive privileges will be used \(see \`DbRoles\(\)\` for reference to ordered list of DbRoles.

## Index

- [type DbRole](<#DbRole>)
  - [func \(dbRole DbRole\) IsDbRoleTenantScoped\(\) bool](<#DbRole.IsDbRoleTenantScoped>)
- [type DbRoleSlice](<#DbRoleSlice>)
  - [func DbRoles\(\) DbRoleSlice](<#DbRoles>)
  - [func \(a DbRoleSlice\) Len\(\) int](<#DbRoleSlice.Len>)
  - [func \(a DbRoleSlice\) Less\(i, j int\) bool](<#DbRoleSlice.Less>)
  - [func \(a DbRoleSlice\) Swap\(i, j int\)](<#DbRoleSlice.Swap>)


<a name="DbRole"></a>
## type [DbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L33>)

DbRole Database roles/users.

```go
type DbRole string
```

<a name="NO_ROLE"></a>

```go
const (
    // NO_ROLE DB Roles.
    NO_ROLE       DbRole = ""
    TENANT_READER DbRole = "tenant_reader"
    READER        DbRole = "reader"
    TENANT_WRITER DbRole = "tenant_writer"
    WRITER        DbRole = "writer"
    MAIN          DbRole = "main"
)
```

<a name="DbRole.IsDbRoleTenantScoped"></a>
### func \(DbRole\) [IsDbRoleTenantScoped](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L66>)

```go
func (dbRole DbRole) IsDbRoleTenantScoped() bool
```



<a name="DbRoleSlice"></a>
## type [DbRoleSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L61>)



```go
type DbRoleSlice []DbRole // Needed for sorting records
```

<a name="DbRoles"></a>
### func [DbRoles](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L50>)

```go
func DbRoles() DbRoleSlice
```

Returns \*Ordered\* slice of DbRoles. A reader role is always considered to have fewer permissions than a writer role. and a tenant\-specific reader/writer role is always considered to have fewer permissions, than a non\-tenant specific reader/writer role, respectively. NO\_ROLE \< TENANT\_READER \< READER \< TENANT\_WRITER \< WRITER.

<a name="DbRoleSlice.Len"></a>
### func \(DbRoleSlice\) [Len](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L62>)

```go
func (a DbRoleSlice) Len() int
```



<a name="DbRoleSlice.Less"></a>
### func \(DbRoleSlice\) [Less](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L83>)

```go
func (a DbRoleSlice) Less(i, j int) bool
```

Returns true if the first role has fewer permissions than the second role, and true if the two roles are the same or the second role has more permissions.

<a name="DbRoleSlice.Swap"></a>
### func \(DbRoleSlice\) [Swap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L87>)

```go
func (a DbRoleSlice) Swap(i, j int)
```



# errors

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/errors"
```

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [type DbError](<#DbError>)
  - [func \(e \*DbError\) Error\(\) string](<#DbError.Error>)
  - [func \(e \*DbError\) Is\(target error\) bool](<#DbError.Is>)
  - [func \(e \*DbError\) Unwrap\(\) error](<#DbError.Unwrap>)
  - [func \(e \*DbError\) With\(msg string\) \*DbError](<#DbError.With>)
  - [func \(e \*DbError\) WithContext\(ctx context.Context\) \*DbError](<#DbError.WithContext>)
  - [func \(e \*DbError\) WithMap\(kvMap map\[ErrorContextKey\]string\) \*DbError](<#DbError.WithMap>)
  - [func \(e \*DbError\) WithValue\(key ErrorContextKey, value string\) \*DbError](<#DbError.WithValue>)
  - [func \(e \*DbError\) Wrap\(err error\) \*DbError](<#DbError.Wrap>)
- [type ErrorContextKey](<#ErrorContextKey>)
  - [func \(c ErrorContextKey\) String\(\) string](<#ErrorContextKey.String>)


## Constants

<a name="ENV_VAR"></a>

```go
const (
    ENV_VAR           = ErrorContextKey("EnvVar")
    VALUE             = ErrorContextKey("Value")
    DB_ADMIN_USERNAME = ErrorContextKey("dbAdminUsername")
    DB_HOST           = ErrorContextKey("dbHost")
    DB_NAME           = ErrorContextKey("dbName")
    DB_PORT           = ErrorContextKey("dbPort")
    DB_USERNAME       = ErrorContextKey("dbUsername")
    PORT_NUMBER       = ErrorContextKey("PortNumber")
    SQL_STMT          = ErrorContextKey("SqlStmt")
    SSL_MODE          = ErrorContextKey("sslMode")
    TABLE_NAME        = ErrorContextKey("TableName")
    TYPE              = ErrorContextKey("Type")
    DB_ROLE           = ErrorContextKey("DbRole")
)
```

## Variables

<a name="ErrBaseDb"></a>

```go
var (
    ErrBaseDb              = &DbError{}
    ErrMissingRoleMapping  = ErrBaseDb.With("Missing role mapping for DB table")
    ErrNotPtrToStructSlice = ErrBaseDb.With("Argument is invalid")
    ErrInvalidPortNumber   = ErrBaseDb.With("Port # is invalid")
    ErrMissingEnvVar       = ErrBaseDb.With("An environment variable is missing or empty")
    ErrMissingOrgId        = ErrBaseDb.With("OrgId is missing in context")
    ErrConnectingToDb      = ErrBaseDb.With("Failed to establish a connection with database")
    ErrExecutingSqlStmt    = ErrBaseDb.With("SQL statement could not be executed")
    ErrRegisteringStruct   = ErrBaseDb.With("Registration of a struct with DAL failed")
    ErrStartingTx          = ErrBaseDb.With("Failed to start a transaction")
    ErrCommittingTx        = ErrBaseDb.With("Failed to commit a transaction")
    ErrRevisionConflict    = ErrBaseDb.With("Blocking update due to outdated revision")
    ErrMarshalling         = ErrBaseDb.With("Cannot marshal proto message to binary")
    ErrUnmarshalling       = ErrBaseDb.With("Cannot unmarshal binary to proto message")
    ErrOperationNotAllowed = ErrBaseDb.With("Not authorized to perform the operation on other's data")
    ErrFetchingMetadata    = ErrBaseDb.With("Error fetching metadata from GRPC context")
    ErrTableDoesNotExist   = ErrBaseDb.With("Table does not exist")
    ErrRecordNotFound      = ErrBaseDb.With("Unable to locate record")
    ErrNotPtrToStruct      = ErrBaseDb.With("PointerToStruct expected, invalid type provided")

    ErrAuthContext       = ErrBaseDb.With("Error extracting authContext from context")
    ErrNoAuthContext     = ErrBaseDb.With("Permission denied because authContext is missing")
    ErrNoUserContext     = ErrBaseDb.With("Permission denied because userInformation is missing")
    ErrUserNotAuthorized = ErrBaseDb.With("User is not authorized to access this API")
    ErrMissingInstanceId = ErrBaseDb.With("Instance ID is not configured in the context")
)
```

<a name="DbError"></a>
## type [DbError](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L85-L89>)



```go
type DbError struct {
    // contains filtered or unexported fields
}
```

<a name="DbError.Error"></a>
### func \(\*DbError\) [Error](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L91>)

```go
func (e *DbError) Error() string
```



<a name="DbError.Is"></a>
### func \(\*DbError\) [Is](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L126>)

```go
func (e *DbError) Is(target error) bool
```



<a name="DbError.Unwrap"></a>
### func \(\*DbError\) [Unwrap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L134>)

```go
func (e *DbError) Unwrap() error
```



<a name="DbError.With"></a>
### func \(\*DbError\) [With](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L146>)

```go
func (e *DbError) With(msg string) *DbError
```



<a name="DbError.WithContext"></a>
### func \(\*DbError\) [WithContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L154>)

```go
func (e *DbError) WithContext(ctx context.Context) *DbError
```



<a name="DbError.WithMap"></a>
### func \(\*DbError\) [WithMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L178>)

```go
func (e *DbError) WithMap(kvMap map[ErrorContextKey]string) *DbError
```



<a name="DbError.WithValue"></a>
### func \(\*DbError\) [WithValue](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L166>)

```go
func (e *DbError) WithValue(key ErrorContextKey, value string) *DbError
```



<a name="DbError.Wrap"></a>
### func \(\*DbError\) [Wrap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L138>)

```go
func (e *DbError) Wrap(err error) *DbError
```



<a name="ErrorContextKey"></a>
## type [ErrorContextKey](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L29>)



```go
type ErrorContextKey string
```

<a name="ErrorContextKey.String"></a>
### func \(ErrorContextKey\) [String](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L162>)

```go
func (c ErrorContextKey) String() string
```



# protostore

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/protostore"
```

This package exposes interface \[pkg.protostore.ProtoStore\] to the consumer, which is a wrapper around \[pkg.datastore.DataStore\] interface and is used specifically to persist Protobuf messages. Just as with \[pkg.datastore.DataStore\], Protobuf messages can be persisted with revisioning and multi\-tenancy support along with \`CreatedAt\` and \`UpdatedAt\` timestamps. Tombstone Delete or soft deletes are supported with \`DeletedAt\` struct field. Use Delete to remove any records that are soft deleted but still in database

## Index

- [func FromBytes\(bytes \[\]byte, message proto.Message\) error](<#FromBytes>)
- [func ToBytes\(message proto.Message\) \(\[\]byte, error\)](<#ToBytes>)
- [type Metadata](<#Metadata>)
  - [func MetadataFrom\(protoStoreMsg ProtoStoreMsg\) Metadata](<#MetadataFrom>)
- [type ProtoStore](<#ProtoStore>)
  - [func GetProtoStore\(logger \*logrus.Entry, ds datastore.DataStore\) ProtoStore](<#GetProtoStore>)
- [type ProtoStoreMsg](<#ProtoStoreMsg>)
  - [func \(msg \*ProtoStoreMsg\) String\(\) string](<#ProtoStoreMsg.String>)
  - [func \(msg \*ProtoStoreMsg\) TableName\(\) string](<#ProtoStoreMsg.TableName>)
- [type ProtobufDataStore](<#ProtobufDataStore>)
  - [func \(p ProtobufDataStore\) DeleteById\(ctx context.Context, id string, msg proto.Message\) \(int64, error\)](<#ProtobufDataStore.DeleteById>)
  - [func \(p ProtobufDataStore\) DropTables\(msgs ...proto.Message\) error](<#ProtobufDataStore.DropTables>)
  - [func \(p ProtobufDataStore\) FindAll\(ctx context.Context, msgs interface\{\}, pagination \*datastore.Pagination\) \(metadataMap map\[string\]Metadata, err error\)](<#ProtobufDataStore.FindAll>)
  - [func \(p ProtobufDataStore\) FindAllAsMap\(ctx context.Context, msgsMap interface\{\}, pagination \*datastore.Pagination\) \(metadataMap map\[string\]Metadata, err error\)](<#ProtobufDataStore.FindAllAsMap>)
  - [func \(p ProtobufDataStore\) FindById\(ctx context.Context, id string, msg proto.Message, metadata \*Metadata\) error](<#ProtobufDataStore.FindById>)
  - [func \(p ProtobufDataStore\) GetAuthorizer\(\) authorizer.Authorizer](<#ProtobufDataStore.GetAuthorizer>)
  - [func \(p ProtobufDataStore\) GetDataStore\(\) datastore.DataStore](<#ProtobufDataStore.GetDataStore>)
  - [func \(p ProtobufDataStore\) GetMetadata\(ctx context.Context, id string, msg proto.Message\) \(md Metadata, err error\)](<#ProtobufDataStore.GetMetadata>)
  - [func \(p ProtobufDataStore\) GetRevision\(ctx context.Context, id string, msg proto.Message\) \(int64, error\)](<#ProtobufDataStore.GetRevision>)
  - [func \(p ProtobufDataStore\) Insert\(ctx context.Context, id string, msg proto.Message\) \(rowsAffected int64, md Metadata, err error\)](<#ProtobufDataStore.Insert>)
  - [func \(p ProtobufDataStore\) InsertWithMetadata\(ctx context.Context, id string, msg proto.Message, metadata Metadata\) \(rowsAffected int64, md Metadata, err error\)](<#ProtobufDataStore.InsertWithMetadata>)
  - [func \(p ProtobufDataStore\) MsgToFilter\(ctx context.Context, id string, msg proto.Message\) \(pMsg \*ProtoStoreMsg, err error\)](<#ProtobufDataStore.MsgToFilter>)
  - [func \(p ProtobufDataStore\) MsgToPersist\(ctx context.Context, id string, msg proto.Message, md Metadata\) \(pMsg \*ProtoStoreMsg, err error\)](<#ProtobufDataStore.MsgToPersist>)
  - [func \(p ProtobufDataStore\) Register\(ctx context.Context, roleMapping map\[string\]dbrole.DbRole, msgs ...proto.Message\) error](<#ProtobufDataStore.Register>)
  - [func \(p ProtobufDataStore\) SoftDeleteById\(ctx context.Context, id string, msg proto.Message\) \(int64, error\)](<#ProtobufDataStore.SoftDeleteById>)
  - [func \(p ProtobufDataStore\) Update\(ctx context.Context, id string, msg proto.Message\) \(rowsAffected int64, md Metadata, err error\)](<#ProtobufDataStore.Update>)
  - [func \(p ProtobufDataStore\) UpdateWithMetadata\(ctx context.Context, id string, msg proto.Message, metadata Metadata\) \(rowsAffected int64, md Metadata, err error\)](<#ProtobufDataStore.UpdateWithMetadata>)
  - [func \(p ProtobufDataStore\) Upsert\(ctx context.Context, id string, msg proto.Message\) \(rowsAffected int64, md Metadata, err error\)](<#ProtobufDataStore.Upsert>)
  - [func \(p ProtobufDataStore\) UpsertWithMetadata\(ctx context.Context, id string, msg proto.Message, metadata Metadata\) \(rowsAffected int64, md Metadata, err error\)](<#ProtobufDataStore.UpsertWithMetadata>)


<a name="FromBytes"></a>
## func [FromBytes](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L109>)

```go
func FromBytes(bytes []byte, message proto.Message) error
```



<a name="ToBytes"></a>
## func [ToBytes](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L117>)

```go
func ToBytes(message proto.Message) ([]byte, error)
```



<a name="Metadata"></a>
## type [Metadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L71-L78>)



```go
type Metadata struct {
    Id        string
    ParentId  string
    Revision  int64
    CreatedAt time.Time
    UpdatedAt time.Time
    DeletedAt gorm.DeletedAt
}
```

<a name="MetadataFrom"></a>
### func [MetadataFrom](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L125>)

```go
func MetadataFrom(protoStoreMsg ProtoStoreMsg) Metadata
```



<a name="ProtoStore"></a>
## type [ProtoStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L45-L69>)



```go
type ProtoStore interface {
    Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, msgs ...proto.Message) error
    Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
    FindAll(ctx context.Context, msgs interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
    FindAllAsMap(ctx context.Context, msgsMap interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
    SoftDeleteById(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)
    DeleteById(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)

    InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
    UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
    UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)

    GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
    GetRevision(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)

    MsgToFilter(ctx context.Context, id string, msg proto.Message) (pMsg *ProtoStoreMsg, err error)
    MsgToPersist(ctx context.Context, id string, msg proto.Message, md Metadata) (pMsg *ProtoStoreMsg, err error)

    GetDataStore() datastore.DataStore
    GetAuthorizer() authorizer.Authorizer
    DropTables(msgs ...proto.Message) error
}
```

<details><summary>Example</summary>
<p>



```go
package main

import (
	"context"
	"fmt"

	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/authorizer"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/datastore"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/dbrole"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/protostore"
	"github.com/vmware-labs/multi-tenant-persistence-for-saas/test/pb"
)

func main() {
	// Initialize protostore with proper logger, authorizer and datastore
	myLogger := datastore.GetCompLogger()
	mdAuthorizer := authorizer.MetadataBasedAuthorizer{}
	myDatastore, _ := datastore.FromEnvWithDB(myLogger, mdAuthorizer, nil, "ExampleProtoStore")
	ctx := mdAuthorizer.GetAuthContext("Coke", "service_admin")
	myProtostore := protostore.GetProtoStore(myLogger, myDatastore)

	// Register protobufs with proper roleMappings
	roleMappingForMemory := map[string]dbrole.DbRole{
		"service_auditor": dbrole.READER,
		"service_admin":   dbrole.WRITER,
	}
	_ = myProtostore.Register(context.TODO(), roleMappingForMemory, &pb.Memory{})

	// Store protobuf message using Upsert
	id := "0001"
	memory := &pb.Memory{
		Brand: "Samsung",
		Size:  32,
		Speed: 2933,
		Type:  "DDR4",
	}
	rowsAffected, metadata, err := myProtostore.Upsert(ctx, id, memory)
	fmt.Println("After Upsert::", "revision:", metadata.Revision, "rowsAffected:", rowsAffected, "err:", err)

	// Retrieve protobuf message using ID
	memory = &pb.Memory{}
	err = myProtostore.FindById(ctx, id, memory, &metadata)
	fmt.Println("FindById::", "revision:", metadata.Revision, "rowsAffected:", rowsAffected, "err:", err)

	// Update the protobuf message with metadata (existing revision)
	memory.Speed++
	rowsAffected, metadata, err = myProtostore.UpdateWithMetadata(ctx, id, memory, metadata)
	fmt.Println("After UpdateWithMetadata::", "revision:", metadata.Revision, "rowsAffected:", rowsAffected, "err:", err)

	// Retrieve all the protobuf messages
	queryResults := make([]*pb.Memory, 0)
	metadataMap, err := myProtostore.FindAll(ctx, &queryResults, datastore.NoPagination())
	fmt.Println("FindAll::", "revision:", metadataMap[id].Revision, "rowsFound:", len(queryResults), "err:", err)

	// Delete the protobuf (soft delete)
	rowsAffected, err = myProtostore.SoftDeleteById(ctx, id, &pb.Memory{})
	fmt.Println("SoftDeleteById::", "rowsAffected:", rowsAffected, "err:", err)

	// Delete the protobuf (full delete)
	rowsAffected, err = myProtostore.DeleteById(ctx, id, &pb.Memory{})
	fmt.Println("DeleteById::", "rowsAffected:", rowsAffected, "err:", err)

}
```

#### Output

```
After Upsert:: revision: 1 rowsAffected: 1 err: <nil>
FindById:: revision: 1 rowsAffected: 1 err: <nil>
After UpdateWithMetadata:: revision: 2 rowsAffected: 1 err: <nil>
FindAll:: revision: 2 rowsFound: 1 err: <nil>
SoftDeleteById:: rowsAffected: 1 err: <nil>
DeleteById:: rowsAffected: 1 err: <nil>
```

</p>
</details>

<a name="GetProtoStore"></a>
### func [GetProtoStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L141>)

```go
func GetProtoStore(logger *logrus.Entry, ds datastore.DataStore) ProtoStore
```



<a name="ProtoStoreMsg"></a>
## type [ProtoStoreMsg](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L80-L91>)



```go
type ProtoStoreMsg struct {
    Id         string         `gorm:"primaryKey" json:"id"`
    Msg        []byte         `json:"-"`
    ParentId   string         `json:"parent_id,omitempty"`
    Revision   int64          `json:"revision"`
    OrgId      string         `gorm:"primaryKey" json:"org_id"`
    InstanceId string         `gorm:"primaryKey" json:"instance_id,omitempty"`
    CreatedAt  time.Time      `json:"-"`
    UpdatedAt  time.Time      `json:"-"`
    DeletedAt  gorm.DeletedAt `json:"-"`
    XTableName string         `gorm:"-" json:"x_table_name"`
}
```

<a name="ProtoStoreMsg.String"></a>
### func \(\*ProtoStoreMsg\) [String](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L97>)

```go
func (msg *ProtoStoreMsg) String() string
```



<a name="ProtoStoreMsg.TableName"></a>
### func \(\*ProtoStoreMsg\) [TableName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L93>)

```go
func (msg *ProtoStoreMsg) TableName() string
```



<a name="ProtobufDataStore"></a>
## type [ProtobufDataStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L136-L139>)



```go
type ProtobufDataStore struct {
    // contains filtered or unexported fields
}
```

<a name="ProtobufDataStore.DeleteById"></a>
### func \(ProtobufDataStore\) [DeleteById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L424>)

```go
func (p ProtobufDataStore) DeleteById(ctx context.Context, id string, msg proto.Message) (int64, error)
```



<a name="ProtobufDataStore.DropTables"></a>
### func \(ProtobufDataStore\) [DropTables](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L432>)

```go
func (p ProtobufDataStore) DropTables(msgs ...proto.Message) error
```



<a name="ProtobufDataStore.FindAll"></a>
### func \(ProtobufDataStore\) [FindAll](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L367>)

```go
func (p ProtobufDataStore) FindAll(ctx context.Context, msgs interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
```

FindAll Finds all messages \(of the same type as the element of msgs\) in Protostore and stores the result in msgs. msgs must be a pointer to a slice of Protobuf structs or a pointer to a slice of pointers to Protobuf structs. It will be modified in\-place. Returns a map of Protobuf messages' IDs to their metadata \(parent ID & revision\).

<a name="ProtobufDataStore.FindAllAsMap"></a>
### func \(ProtobufDataStore\) [FindAllAsMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L309>)

```go
func (p ProtobufDataStore) FindAllAsMap(ctx context.Context, msgsMap interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
```



<a name="ProtobufDataStore.FindById"></a>
### func \(ProtobufDataStore\) [FindById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L275>)

```go
func (p ProtobufDataStore) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
```

Finds a Protobuf message by ID. If metadata arg. is non\-nil, fills it with the metadata \(parent ID & revision\) of the Protobuf message that was found.

<a name="ProtobufDataStore.GetAuthorizer"></a>
### func \(ProtobufDataStore\) [GetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L153>)

```go
func (p ProtobufDataStore) GetAuthorizer() authorizer.Authorizer
```



<a name="ProtobufDataStore.GetDataStore"></a>
### func \(ProtobufDataStore\) [GetDataStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L149>)

```go
func (p ProtobufDataStore) GetDataStore() datastore.DataStore
```



<a name="ProtobufDataStore.GetMetadata"></a>
### func \(ProtobufDataStore\) [GetMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L291>)

```go
func (p ProtobufDataStore) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
```



<a name="ProtobufDataStore.GetRevision"></a>
### func \(ProtobufDataStore\) [GetRevision](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L300>)

```go
func (p ProtobufDataStore) GetRevision(ctx context.Context, id string, msg proto.Message) (int64, error)
```



<a name="ProtobufDataStore.Insert"></a>
### func \(ProtobufDataStore\) [Insert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L170>)

```go
func (p ProtobufDataStore) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

@DEPRECATED See \[InsertWithMetadata\].

<a name="ProtobufDataStore.InsertWithMetadata"></a>
### func \(ProtobufDataStore\) [InsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L179>)

```go
func (p ProtobufDataStore) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Inserts a new Protobuf record in the DB. Returns, rowsAffected \- 0 if insertion fails; 1 otherwise md \- metadata of the new Protobuf record err \- error that occurred during insertion, if any.

<a name="ProtobufDataStore.MsgToFilter"></a>
### func \(ProtobufDataStore\) [MsgToFilter](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L465>)

```go
func (p ProtobufDataStore) MsgToFilter(ctx context.Context, id string, msg proto.Message) (pMsg *ProtoStoreMsg, err error)
```

Return the ProtoStoreMsg that can be used for filtering with id/orgId filled up and error that occurred during extraction orgId from context.

<a name="ProtobufDataStore.MsgToPersist"></a>
### func \(ProtobufDataStore\) [MsgToPersist](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L446>)

```go
func (p ProtobufDataStore) MsgToPersist(ctx context.Context, id string, msg proto.Message, md Metadata) (pMsg *ProtoStoreMsg, err error)
```

Return the serialized ProtoStoreMsg that can be persisted to database and error that occurred during extraction orgId from context, or serialization.

<a name="ProtobufDataStore.Register"></a>
### func \(ProtobufDataStore\) [Register](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L157>)

```go
func (p ProtobufDataStore) Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, msgs ...proto.Message) error
```



<a name="ProtobufDataStore.SoftDeleteById"></a>
### func \(ProtobufDataStore\) [SoftDeleteById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L416>)

```go
func (p ProtobufDataStore) SoftDeleteById(ctx context.Context, id string, msg proto.Message) (int64, error)
```



<a name="ProtobufDataStore.Update"></a>
### func \(ProtobufDataStore\) [Update](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L203>)

```go
func (p ProtobufDataStore) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Update Fetches metadata for the record and updates the Protobuf message. NOTE: Avoid using this method in user\-workflows and only in service\-to\-service workflows when the updates are already ordered by some other service/app.

<a name="ProtobufDataStore.UpdateWithMetadata"></a>
### func \(ProtobufDataStore\) [UpdateWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L216>)

```go
func (p ProtobufDataStore) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Updates an existing Protobuf record in the DB. Returns, rowsAffected \- 0 if update fails; 1 otherwise md \- metadata of the updated Protobuf record err \- error that occurred during update, if any.

<a name="ProtobufDataStore.Upsert"></a>
### func \(ProtobufDataStore\) [Upsert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L235>)

```go
func (p ProtobufDataStore) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Upsert Fetches metadata for the record and upserts the Protobuf message. NOTE: Avoid using this method in user\-workflows and only in service\-to\-service workflows when the updates are already ordered by some other service/app.

<a name="ProtobufDataStore.UpsertWithMetadata"></a>
### func \(ProtobufDataStore\) [UpsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L253-L255>)

```go
func (p ProtobufDataStore) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Upserts a Protobuf record in the DB \(if the record exists, it is updated; if it does not, it is inserted\). Returns, rowsAffected \- 0 if upsert fails; 1 otherwise md \- metadata of the upserted Protobuf record err \- error that occurred during upsert, if any.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
