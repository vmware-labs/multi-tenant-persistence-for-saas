<!-- Code generated by gomarkdoc. DO NOT EDIT -->

[![Go Report Card](https://goreportcard.com/badge/github.com/vmware-labs/multi-tenant-persistence-for-saas)](https://goreportcard.com/report/github.com/vmware-labs/multi-tenant-persistence-for-saas)
[![GitHub Actions](https://github.com/vmware-labs/multi-tenant-persistence-for-saas/actions/workflows/go.yml/badge.svg)](https://github.com/vmware-labs/multi-tenant-persistence-for-saas/actions?query=branch%3Amaster)
[![Go Reference](https://pkg.go.dev/badge/github.com/vmware-labs/multi-tenant-persistence-for-saas/)](https://pkg.go.dev/github.com/vmware-labs/multi-tenant-persistence-for-saas)
[![Code Coverage](https://codecov.io/gh/vmware-labs/multi-tenant-persistence-for-saas/branch/main/graph/badge.svg?token=F7TQPSFEMCN)](https://app.codecov.io/gh/vmware-labs/multi-tenant-persistence-for-saas)
# authorizer

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/authorizer"
```

## Index

- [Constants](<#constants>)
- [type Authorizer](<#type-authorizer>)
- [type MetadataBasedAuthorizer](<#type-metadatabasedauthorizer>)
  - [func (s MetadataBasedAuthorizer) Configure(_ string, _ map[string]dbrole.DbRole)](<#func-metadatabasedauthorizer-configure>)
  - [func (s MetadataBasedAuthorizer) GetAuthContext(orgId string, roles ...string) context.Context](<#func-metadatabasedauthorizer-getauthcontext>)
  - [func (s MetadataBasedAuthorizer) GetDefaultOrgAdminContext() context.Context](<#func-metadatabasedauthorizer-getdefaultorgadmincontext>)
  - [func (s MetadataBasedAuthorizer) GetMatchingDbRole(ctx context.Context, _ ...string) (dbrole.DbRole, error)](<#func-metadatabasedauthorizer-getmatchingdbrole>)
  - [func (s MetadataBasedAuthorizer) GetOrgFromContext(ctx context.Context) (string, error)](<#func-metadatabasedauthorizer-getorgfromcontext>)


## Constants

```go
const (
    GLOBAL_DEFAULT_ORG_ID = "_GlobalDefaultOrg"

    METADATA_KEY_ORGID            = "orgid"
    METADATA_KEY_ROLE             = "role"
    METADATA_ROLE_SERVICE_ADMIN   = "service_admin"
    METADATA_ROLE_SERVICE_AUDITOR = "service_auditor"
    METADATA_ROLE_ADMIN           = "admin"   // can be tenant_admin, *_admin
    METADATA_ROLE_AUDITOR         = "auditor" // can be tenant_auditor, *_auditor
)
```

## type [Authorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/authorizer.go#L30-L36>)

Authorizer Interface defines the methods required for datastore to restrict access based on roles configured in context.

```go
type Authorizer interface {
    Configure(tableName string, roleMapping map[string]dbrole.DbRole)
    GetAuthContext(orgId string, roles ...string) context.Context
    GetDefaultOrgAdminContext() context.Context
    GetOrgFromContext(ctx context.Context) (string, error)
    GetMatchingDbRole(ctx context.Context, tableNames ...string) (dbrole.DbRole, error)
}
```

## type [MetadataBasedAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L41>)

```go
type MetadataBasedAuthorizer struct{}
```

### func \(MetadataBasedAuthorizer\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L79>)

```go
func (s MetadataBasedAuthorizer) Configure(_ string, _ map[string]dbrole.DbRole)
```

### func \(MetadataBasedAuthorizer\) [GetAuthContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L84>)

```go
func (s MetadataBasedAuthorizer) GetAuthContext(orgId string, roles ...string) context.Context
```

### func \(MetadataBasedAuthorizer\) [GetDefaultOrgAdminContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L88>)

```go
func (s MetadataBasedAuthorizer) GetDefaultOrgAdminContext() context.Context
```

### func \(MetadataBasedAuthorizer\) [GetMatchingDbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L57>)

```go
func (s MetadataBasedAuthorizer) GetMatchingDbRole(ctx context.Context, _ ...string) (dbrole.DbRole, error)
```

### func \(MetadataBasedAuthorizer\) [GetOrgFromContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/authorizer/metadata_authorizer.go#L43>)

```go
func (s MetadataBasedAuthorizer) GetOrgFromContext(ctx context.Context) (string, error)
```

# datastore

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/datastore"
```

Import the package and use \`DataStore\` interface to interact with the data access layer. If you want DAL to use a Postgres database, ensure you have the following environment variables set to relevant values: \*DB\_ADMIN\_USERNAME\*, \*DB\_PORT\*, \*DB\_NAME\*, \*DB\_ADMIN\_PASSWORD\*, \*DB\_HOST\*, \*SSL\_MODE\*. You can also set \*LOG\_LEVEL\* environment variable to debug/trace, if you want logging at a specific level \(default is \_Info\_\)

Define structs that will be persisted using datastore similar to any gorm Models, for reference \[https://gorm.io/docs/models.html\]

\- At least one field must be a primary key \(contain a \*primary\_key\* tag with the value of \*true\*\). \- For revision support to block concurrent updates, add \_\_revision\_ as column tag. \- For multi\-tenancy support, add an \_org\_id\_ tag to a field.

```
type App struct {
		Id       string `gorm:"primaryKey;column:application_id"`
		Name     string
		TenantId string `gorm:"primaryKey;column:org_id"`
		Revision int64  `gorm:"column:revision"`
	}

DataStore.Register(context.TODO(), roleMappingForAppUser, appUser{})

datastore.DataStore.Insert(ctx, user1)
var queryResult appUser = appUser{Id: user1.Id}
DataStore.Find(ctx, &queryResult)

queryResults := make([]appUser, 0)
DataStore.FindAll(ctx, &queryResults)

DataStore.Delete(ctx, user1)
```

DataStore interface exposes basic methods like Find/FindAll/Upsert/Delete, for richer queries and transaction based filtering and pagination please use GetTransaction\(\) method. Sample usage using db transactions,

```
t.Log("Getting DBTransaction for creating App and AppUser")
tx, err := TestDataStore.GetTransaction(CokeAdminCtx, app, appUser)
assert.NoError(err)
t.Log("Creating app and appUser in single transaction")
err = tx.Transaction(func(tx *gorm.DB) error {
	if err := tx.Create(app).Error; err != nil {
		return err
	}
	if err := tx.Create(appUser).Error; err != nil {
		return err
	}

	return nil
})
tx.Commit()
```

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func GetCompLogger() *logrus.Entry](<#func-getcomplogger>)
- [func GetGormLogger(l *logrus.Entry) logger.Interface](<#func-getgormlogger>)
- [func GetLogLevel() string](<#func-getloglevel>)
- [func GetLogger() *logrus.Logger](<#func-getlogger>)
- [func GetOrgId(record Record) (string, bool)](<#func-getorgid>)
- [func GetTableName(x interface{}) (tableName string)](<#func-gettablename>)
- [func IsMultitenant(x Record, tableNames ...string) bool](<#func-ismultitenant>)
- [func IsPointerToStruct(x interface{}) (isPtrType bool)](<#func-ispointertostruct>)
- [func IsRevisioningSupported(tableName string, x Record) bool](<#func-isrevisioningsupported>)
- [func TypeName(x interface{}) string](<#func-typename>)
- [type DBConfig](<#type-dbconfig>)
- [type DataStore](<#type-datastore>)
  - [func FromConfig(l *logrus.Entry, authorizer authorizer.Authorizer, cfg DBConfig) (d DataStore, err error)](<#func-fromconfig>)
  - [func FromEnv(l *logrus.Entry, authorizer authorizer.Authorizer) (d DataStore, err error)](<#func-fromenv>)
- [type Helper](<#type-helper>)
- [type Pagination](<#type-pagination>)
  - [func DefaultPagination() *Pagination](<#func-defaultpagination>)
  - [func GetPagination(offset int, limit int, sortBy string) *Pagination](<#func-getpagination>)
  - [func NoPagination() *Pagination](<#func-nopagination>)
- [type Record](<#type-record>)
  - [func GetRecordInstanceFromSlice(x interface{}) Record](<#func-getrecordinstancefromslice>)
- [type TestHelper](<#type-testhelper>)


## Constants

```go
const (
    // Env. variable names.
    DB_NAME_ENV_VAR           = "DB_NAME"
    DB_PORT_ENV_VAR           = "DB_PORT"
    DB_HOST_ENV_VAR           = "DB_HOST"
    SSL_MODE_ENV_VAR          = "SSL_MODE"
    DB_ADMIN_USERNAME_ENV_VAR = "DB_ADMIN_USERNAME"
    DB_ADMIN_PASSWORD_ENV_VAR = "DB_ADMIN_PASSWORD"

    // SQL Error Codes.
    ERROR_DUPLICATE_KEY = "SQLSTATE 23505"
)
```

```go
const (
    // Logging configuration variables.
    LOG_LEVEL_ENV_VAR = "LOG_LEVEL"

    // Constants for LOG field names & values.
    COMP             = "comp"
    SAAS_PERSISTENCE = "persistence"
)
```

```go
const (
    DEFAULT_OFFSET = 0
    DEFAULT_LIMIT  = 1000
    DEFAULT_SORTBY = ""
)
```

```go
const (
    // Struct Field Names.
    FIELD_ORGID = "OrgId"

    // SQL Columns.
    COLUMN_ORGID    = "org_id"
    COLUMN_REVISION = "revision"

    // Messages.
    REVISION_OUTDATED_MSG = "Invalid update - outdated "
)
```

```go
const (
    DbConfigOrgId = "multitenant.orgId" // Name of Postgres run-time config. parameter that will store current user's org. ID
)
```

## Variables

```go
var TRACE = func(format string, v ...any) {
}
```

## func [GetCompLogger](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L79>)

```go
func GetCompLogger() *logrus.Entry
```

## func [GetGormLogger](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L70>)

```go
func GetGormLogger(l *logrus.Entry) logger.Interface
```

## func [GetLogLevel](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L47>)

```go
func GetLogLevel() string
```

## func [GetLogger](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/logger.go#L51>)

```go
func GetLogger() *logrus.Logger
```

## func [GetOrgId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L362>)

```go
func GetOrgId(record Record) (string, bool)
```

Returns the requested OrgId field's value from record, which is a pointer to a struct implementing Record interface.  Uses a tag rather than field name to find the desired field. Returns an empty string and false if such a field is not present.

## func [GetTableName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L225>)

```go
func GetTableName(x interface{}) (tableName string)
```

Extracts struct's name, which will serve as DB table name, using reflection.

## func [IsMultitenant](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L62>)

```go
func IsMultitenant(x Record, tableNames ...string) bool
```

Checks if any of the tables in tableNames are multi\-tenant.

## func [IsPointerToStruct](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L209>)

```go
func IsPointerToStruct(x interface{}) (isPtrType bool)
```

## func [IsRevisioningSupported](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L51>)

```go
func IsRevisioningSupported(tableName string, x Record) bool
```

Checks if revisioning is supported in the given table \(if the struct contains a field with column name equal to "revision"\).

## func [TypeName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/sql_struct.go#L205>)

```go
func TypeName(x interface{}) string
```

## type [DBConfig](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L49-L56>)

```go
type DBConfig struct {
    // contains filtered or unexported fields
}
```

## type [DataStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/datastore.go#L81-L97>)

DataStore /\*.

```go
type DataStore interface {
    Find(ctx context.Context, record Record) error
    FindAll(ctx context.Context, records interface{}, pagination *Pagination) error
    FindWithFilter(ctx context.Context, filter Record, records interface{}, pagination *Pagination) error
    Insert(ctx context.Context, record Record) (int64, error)
    Delete(ctx context.Context, record Record) (int64, error)
    Update(ctx context.Context, record Record) (int64, error)
    Upsert(ctx context.Context, record Record) (int64, error)
    GetTransaction(ctx context.Context, record ...Record) (tx *gorm.DB, err error)

    Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, records ...Record) error
    Reset()

    GetAuthorizer() authorizer.Authorizer
    Helper() Helper
    TestHelper() TestHelper
}
```

### func [FromConfig](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L98>)

```go
func FromConfig(l *logrus.Entry, authorizer authorizer.Authorizer, cfg DBConfig) (d DataStore, err error)
```

### func [FromEnv](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/helper.go#L58>)

```go
func FromEnv(l *logrus.Entry, authorizer authorizer.Authorizer) (d DataStore, err error)
```

## type [Helper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/datastore.go#L99-L105>)

```go
type Helper interface {
    FindAllInTable(ctx context.Context, tableName string, records interface{}, pagination *Pagination) error
    FindWithFilterInTable(ctx context.Context, tableName string, record Record, records interface{}, pagination *Pagination) error
    GetDBTransaction(ctx context.Context, tableName string, record Record) (tx *gorm.DB, err error)

    RegisterHelper(ctx context.Context, roleMapping map[string]dbrole.DbRole, tableName string, record Record) error
}
```

## type [Pagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L27-L31>)

```go
type Pagination struct {
    Offset int
    Limit  int
    SortBy string
}
```

### func [DefaultPagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L41>)

```go
func DefaultPagination() *Pagination
```

### func [GetPagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L33>)

```go
func GetPagination(offset int, limit int, sortBy string) *Pagination
```

### func [NoPagination](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/pagination.go#L45>)

```go
func NoPagination() *Pagination
```

## type [Record](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/record.go#L23-L26>)

```go
type Record interface {
}
```

### func [GetRecordInstanceFromSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/record.go#L28>)

```go
func GetRecordInstanceFromSlice(x interface{}) Record
```

## type [TestHelper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/datastore/datastore.go#L107-L111>)

```go
type TestHelper interface {
    DropTables(records ...Record) error                       // Drop DB tables by records
    Truncate(tableNames ...string) error                      // Truncates DB tables
    TruncateCascade(cascade bool, tableNames ...string) error // Truncates DB tables, with an option to truncate them in a cascading fashion
}
```

# dbrole

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/dbrole"
```

DAL uses 4 database roles/users to perform all operations,

```
- `TENANT_READER` - has read access to its tenant's data
	- `READER` - has read access to all tenants' data
	- `TENANT_WRITER` - has read & write access to its tenant's data
	- `WRITER` - has read & write access to all tenants' data

 DAL allows to map a user's service role to the DB role that will be used for
 that user. If a user has multiple service roles which map to several DB roles,
 the DB role with the most extensive privileges will be used (see `DbRoles()`
 for reference to ordered list of DbRoles.
```

## Index

- [type DbRole](<#type-dbrole>)
  - [func (dbRole DbRole) IsDbRoleTenantScoped() bool](<#func-dbrole-isdbroletenantscoped>)
- [type DbRoleSlice](<#type-dbroleslice>)
  - [func DbRoles() DbRoleSlice](<#func-dbroles>)
  - [func (a DbRoleSlice) Len() int](<#func-dbroleslice-len>)
  - [func (a DbRoleSlice) Less(i, j int) bool](<#func-dbroleslice-less>)
  - [func (a DbRoleSlice) Swap(i, j int)](<#func-dbroleslice-swap>)


## type [DbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L33>)

DbRole Database roles/users.

```go
type DbRole string
```

```go
const (
    // NO_ROLE DB Roles.
    NO_ROLE       DbRole = ""
    TENANT_READER DbRole = "tenant_reader"
    READER        DbRole = "reader"
    TENANT_WRITER DbRole = "tenant_writer"
    WRITER        DbRole = "writer"
    MAIN          DbRole = "main"
)
```

### func \(DbRole\) [IsDbRoleTenantScoped](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L66>)

```go
func (dbRole DbRole) IsDbRoleTenantScoped() bool
```

## type [DbRoleSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L61>)

```go
type DbRoleSlice []DbRole // Needed for sorting records
```

### func [DbRoles](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L50>)

```go
func DbRoles() DbRoleSlice
```

Returns \*Ordered\* slice of DbRoles. A reader role is always considered to have fewer permissions than a writer role. and a tenant\-specific reader/writer role is always considered to have fewer permissions, than a non\-tenant specific reader/writer role, respectively. NO\_ROLE \< TENANT\_READER \< READER \< TENANT\_WRITER \< WRITER.

### func \(DbRoleSlice\) [Len](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L62>)

```go
func (a DbRoleSlice) Len() int
```

### func \(DbRoleSlice\) [Less](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L83>)

```go
func (a DbRoleSlice) Less(i, j int) bool
```

Returns true if the first role has fewer permissions than the second role, and true if the two roles are the same or the second role has more permissions.

### func \(DbRoleSlice\) [Swap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/dbrole/dbrole.go#L87>)

```go
func (a DbRoleSlice) Swap(i, j int)
```

# errors

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/errors"
```

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [type DbError](<#type-dberror>)
  - [func (e *DbError) Error() string](<#func-dberror-error>)
  - [func (e *DbError) Is(target error) bool](<#func-dberror-is>)
  - [func (e *DbError) Unwrap() error](<#func-dberror-unwrap>)
  - [func (e *DbError) With(msg string) *DbError](<#func-dberror-with>)
  - [func (e *DbError) WithContext(ctx context.Context) *DbError](<#func-dberror-withcontext>)
  - [func (e *DbError) WithMap(kvMap map[ErrorContextKey]string) *DbError](<#func-dberror-withmap>)
  - [func (e *DbError) WithValue(key ErrorContextKey, value string) *DbError](<#func-dberror-withvalue>)
  - [func (e *DbError) Wrap(err error) *DbError](<#func-dberror-wrap>)
- [type ErrorContextKey](<#type-errorcontextkey>)
  - [func (c ErrorContextKey) String() string](<#func-errorcontextkey-string>)


## Constants

```go
const (
    ENV_VAR           = ErrorContextKey("EnvVar")
    VALUE             = ErrorContextKey("Value")
    DB_ADMIN_USERNAME = ErrorContextKey("dbAdminUsername")
    DB_HOST           = ErrorContextKey("dbHost")
    DB_NAME           = ErrorContextKey("dbName")
    DB_PORT           = ErrorContextKey("dbPort")
    DB_USERNAME       = ErrorContextKey("dbUsername")
    PORT_NUMBER       = ErrorContextKey("PortNumber")
    SQL_STMT          = ErrorContextKey("SqlStmt")
    SSL_MODE          = ErrorContextKey("sslMode")
    TABLE_NAME        = ErrorContextKey("TableName")
    TYPE              = ErrorContextKey("Type")
    DB_ROLE           = ErrorContextKey("DbRole")
)
```

## Variables

```go
var (
    ErrBaseDb              = &DbError{}
    ErrMissingRoleMapping  = ErrBaseDb.With("Missing role mapping for DB table")
    ErrNotPtrToStructSlice = ErrBaseDb.With("Argument is invalid")
    ErrInvalidPortNumber   = ErrBaseDb.With("Port # is invalid")
    ErrMissingEnvVar       = ErrBaseDb.With("An environment variable is missing or empty")
    ErrMissingOrgId        = ErrBaseDb.With("OrgId is missing in context")
    ErrConnectingToDb      = ErrBaseDb.With("Failed to establish a connection with database")
    ErrExecutingSqlStmt    = ErrBaseDb.With("SQL statement could not be executed")
    ErrRegisteringStruct   = ErrBaseDb.With("Registration of a struct with DAL failed")
    ErrStartingTx          = ErrBaseDb.With("Failed to start a transaction")
    ErrCommittingTx        = ErrBaseDb.With("Failed to commit a transaction")
    ErrRevisionConflict    = ErrBaseDb.With("Blocking update due to outdated revision")
    ErrMarshalling         = ErrBaseDb.With("Cannot marshal proto message to binary")
    ErrUnmarshalling       = ErrBaseDb.With("Cannot unmarshal binary to proto message")
    ErrOperationNotAllowed = ErrBaseDb.With("Not authorized to perform the operation on other tenant's data")
    ErrFetchingMetadata    = ErrBaseDb.With("Error fetching metadata from GRPC context")
    ErrTableDoesNotExist   = ErrBaseDb.With("Table does not exist")
    ErrRecordNotFound      = ErrBaseDb.With("Record not found")
    ErrNotPtrToStruct      = ErrBaseDb.With("PointerToStruct expected, invalid type provided")

    ErrAuthContext       = ErrBaseDb.With("Error extracting authContext from context")
    ErrNoAuthContext     = ErrBaseDb.With("Permission denied because authContext is missing")
    ErrNoUserContext     = ErrBaseDb.With("Permission denied because userInformation is missing")
    ErrUserNotAuthorized = ErrBaseDb.With("User is not authorized to access this API")
)
```

## type [DbError](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L75-L79>)

```go
type DbError struct {
    // contains filtered or unexported fields
}
```

### func \(\*DbError\) [Error](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L81>)

```go
func (e *DbError) Error() string
```

### func \(\*DbError\) [Is](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L92>)

```go
func (e *DbError) Is(target error) bool
```

### func \(\*DbError\) [Unwrap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L100>)

```go
func (e *DbError) Unwrap() error
```

### func \(\*DbError\) [With](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L112>)

```go
func (e *DbError) With(msg string) *DbError
```

### func \(\*DbError\) [WithContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L120>)

```go
func (e *DbError) WithContext(ctx context.Context) *DbError
```

### func \(\*DbError\) [WithMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L144>)

```go
func (e *DbError) WithMap(kvMap map[ErrorContextKey]string) *DbError
```

### func \(\*DbError\) [WithValue](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L132>)

```go
func (e *DbError) WithValue(key ErrorContextKey, value string) *DbError
```

### func \(\*DbError\) [Wrap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L104>)

```go
func (e *DbError) Wrap(err error) *DbError
```

## type [ErrorContextKey](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L28>)

```go
type ErrorContextKey string
```

### func \(ErrorContextKey\) [String](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/errors/error_codes.go#L128>)

```go
func (c ErrorContextKey) String() string
```

# protostore

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/protostore"
```

This package exposes interface \[pkg.protostore.ProtoStore\] to the consumer, which is a wrapper around \[pkg.datastore.DataStore\] interface and is used specifically to persist Protobuf messages. Just as with \[pkg.datastore.DataStore\], Protobuf messages can be persisted with revisioning and multi\-tenancy support along with \`CreatedAt\` and \`UpdatedAt\` timestamps.

Sample Usage,

```
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/pkg/protostore"

// Initialize protostore with proper logger and role Mappings
protoStore := protostore.GetProtoStore(myLogger, myDatastore)
roleMappingForMemory := map[string]DbRole{
	APP_ADMIN:     datastore.READER,
    SERVICE_ADMIN: datastore.WRITER,
}
protoStore.Register(context.TODO(), roleMappingForMemory, &pb.Memory{})

// Store protobuf message using Upsert
id := "001"
memory := pb.Memory{
  Brand: "Samsung",
  Size:  32,
  Speed: 2933,
  Type:  "DDR4",
}
protoStore.Upsert(ctx, id, &memory)

// Retrieve protobuf message using ID
memory = pb.Memory{}
var metadata = Metadata{}
protoStore.FindById(ctx, id, &memory, &metadata)

// Update the protobuf message with metadata (existing revision)
memory.Speed++
protoStore.UpdateWithMetadata(ctx, id, &memory, metadata)

// Retrieve all the protobuf messages
var queryResults = make([]*pb.Memory, 0)
metadataMap, _ := protoStore.FindAll(ctx, queryResults)

// Update the protobuf without metadata (without revision, NOT RECOMMENDED)
memory.Speed++
protoStore.Update(ctx, id, memory) //Update()

// Delete the protobuf
protoStore.DeleteById(ctx, id, &pb.Memory{})
```

## Index

- [func FromBytes(bytes []byte, message proto.Message) error](<#func-frombytes>)
- [func ToBytes(message proto.Message) ([]byte, error)](<#func-tobytes>)
- [type Metadata](<#type-metadata>)
  - [func MetadataFrom(protoStoreMsg ProtoStoreMsg) Metadata](<#func-metadatafrom>)
- [type ProtoStore](<#type-protostore>)
  - [func GetProtoStore(logger *logrus.Entry, ds datastore.DataStore) ProtoStore](<#func-getprotostore>)
- [type ProtoStoreMsg](<#type-protostoremsg>)
  - [func (msg *ProtoStoreMsg) TableName() string](<#func-protostoremsg-tablename>)
- [type ProtobufDataStore](<#type-protobufdatastore>)
  - [func (p ProtobufDataStore) DeleteById(ctx context.Context, id string, msg proto.Message) (int64, error)](<#func-protobufdatastore-deletebyid>)
  - [func (p ProtobufDataStore) DropTables(msgs ...proto.Message) error](<#func-protobufdatastore-droptables>)
  - [func (p ProtobufDataStore) FindAll(ctx context.Context, msgs interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)](<#func-protobufdatastore-findall>)
  - [func (p ProtobufDataStore) FindAllAsMap(ctx context.Context, msgsMap interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)](<#func-protobufdatastore-findallasmap>)
  - [func (p ProtobufDataStore) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error](<#func-protobufdatastore-findbyid>)
  - [func (p ProtobufDataStore) GetAuthorizer() authorizer.Authorizer](<#func-protobufdatastore-getauthorizer>)
  - [func (p ProtobufDataStore) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)](<#func-protobufdatastore-getmetadata>)
  - [func (p ProtobufDataStore) GetRevision(ctx context.Context, id string, msg proto.Message) (int64, error)](<#func-protobufdatastore-getrevision>)
  - [func (p ProtobufDataStore) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-insert>)
  - [func (p ProtobufDataStore) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-insertwithmetadata>)
  - [func (p ProtobufDataStore) MsgToFilter(ctx context.Context, id string, msg proto.Message) (pMsg *ProtoStoreMsg, err error)](<#func-protobufdatastore-msgtofilter>)
  - [func (p ProtobufDataStore) MsgToPersist(ctx context.Context, id string, msg proto.Message, md Metadata) (pMsg *ProtoStoreMsg, err error)](<#func-protobufdatastore-msgtopersist>)
  - [func (p ProtobufDataStore) Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, msgs ...proto.Message) error](<#func-protobufdatastore-register>)
  - [func (p ProtobufDataStore) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-update>)
  - [func (p ProtobufDataStore) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-updatewithmetadata>)
  - [func (p ProtobufDataStore) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-upsert>)
  - [func (p ProtobufDataStore) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-upsertwithmetadata>)


## func [FromBytes](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L129>)

```go
func FromBytes(bytes []byte, message proto.Message) error
```

## func [ToBytes](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L137>)

```go
func ToBytes(message proto.Message) ([]byte, error)
```

## type [Metadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L106-L112>)

```go
type Metadata struct {
    Id        string
    ParentId  string
    Revision  int64
    CreatedAt time.Time
    UpdatedAt time.Time
}
```

### func [MetadataFrom](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L145>)

```go
func MetadataFrom(protoStoreMsg ProtoStoreMsg) Metadata
```

## type [ProtoStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L82-L104>)

```go
type ProtoStore interface {
    Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, msgs ...proto.Message) error
    Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
    FindAll(ctx context.Context, msgs interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
    FindAllAsMap(ctx context.Context, msgsMap interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
    DeleteById(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)

    InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
    UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
    UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)

    GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
    GetRevision(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)

    MsgToFilter(ctx context.Context, id string, msg proto.Message) (pMsg *ProtoStoreMsg, err error)
    MsgToPersist(ctx context.Context, id string, msg proto.Message, md Metadata) (pMsg *ProtoStoreMsg, err error)

    GetAuthorizer() authorizer.Authorizer
    DropTables(msgs ...proto.Message) error
}
```

### func [GetProtoStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L160>)

```go
func GetProtoStore(logger *logrus.Entry, ds datastore.DataStore) ProtoStore
```

## type [ProtoStoreMsg](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L114-L123>)

```go
type ProtoStoreMsg struct {
    Id         string `gorm:"primaryKey"`
    Msg        []byte
    ParentId   string
    Revision   int64
    OrgId      string `gorm:"primaryKey"`
    CreatedAt  time.Time
    UpdatedAt  time.Time
    XTableName string `gorm:"-"`
}
```

### func \(\*ProtoStoreMsg\) [TableName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L125>)

```go
func (msg *ProtoStoreMsg) TableName() string
```

## type [ProtobufDataStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L155-L158>)

```go
type ProtobufDataStore struct {
    // contains filtered or unexported fields
}
```

### func \(ProtobufDataStore\) [DeleteById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L431>)

```go
func (p ProtobufDataStore) DeleteById(ctx context.Context, id string, msg proto.Message) (int64, error)
```

### func \(ProtobufDataStore\) [DropTables](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L439>)

```go
func (p ProtobufDataStore) DropTables(msgs ...proto.Message) error
```

### func \(ProtobufDataStore\) [FindAll](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L382>)

```go
func (p ProtobufDataStore) FindAll(ctx context.Context, msgs interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
```

FindAll Finds all messages \(of the same type as the element of msgs\) in Protostore and stores the result in msgs. msgs must be a pointer to a slice of Protobuf structs or a pointer to a slice of pointers to Protobuf structs. It will be modified in\-place. Returns a map of Protobuf messages' IDs to their metadata \(parent ID & revision\).

### func \(ProtobufDataStore\) [FindAllAsMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L324>)

```go
func (p ProtobufDataStore) FindAllAsMap(ctx context.Context, msgsMap interface{}, pagination *datastore.Pagination) (metadataMap map[string]Metadata, err error)
```

### func \(ProtobufDataStore\) [FindById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L290>)

```go
func (p ProtobufDataStore) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
```

Finds a Protobuf message by ID. If metadata arg. is non\-nil, fills it with the metadata \(parent ID & revision\) of the Protobuf message that was found.

### func \(ProtobufDataStore\) [GetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L168>)

```go
func (p ProtobufDataStore) GetAuthorizer() authorizer.Authorizer
```

### func \(ProtobufDataStore\) [GetMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L306>)

```go
func (p ProtobufDataStore) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
```

### func \(ProtobufDataStore\) [GetRevision](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L315>)

```go
func (p ProtobufDataStore) GetRevision(ctx context.Context, id string, msg proto.Message) (int64, error)
```

### func \(ProtobufDataStore\) [Insert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L185>)

```go
func (p ProtobufDataStore) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

@DEPRECATD See \[InsertWithMetadata\].

### func \(ProtobufDataStore\) [InsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L194>)

```go
func (p ProtobufDataStore) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Inserts a new Protobuf record in the DB. Returns, rowsAffected \- 0 if insertion fails; 1 otherwise md \- metadata of the new Protobuf record err \- error that occurred during insertion, if any.

### func \(ProtobufDataStore\) [MsgToFilter](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L471>)

```go
func (p ProtobufDataStore) MsgToFilter(ctx context.Context, id string, msg proto.Message) (pMsg *ProtoStoreMsg, err error)
```

Return the ProtoStoreMsg that can be used for filtering with id/orgId filled up and error that occurred during extraction orgId from context.

### func \(ProtobufDataStore\) [MsgToPersist](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L452>)

```go
func (p ProtobufDataStore) MsgToPersist(ctx context.Context, id string, msg proto.Message, md Metadata) (pMsg *ProtoStoreMsg, err error)
```

Return the serialized ProtoStoreMsg that can be persisted to database and error that occurred during extraction orgId from context, or serialization.

### func \(ProtobufDataStore\) [Register](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L172>)

```go
func (p ProtobufDataStore) Register(ctx context.Context, roleMapping map[string]dbrole.DbRole, msgs ...proto.Message) error
```

### func \(ProtobufDataStore\) [Update](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L218>)

```go
func (p ProtobufDataStore) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Update Fetches metadata for the record and updates the Protobuf message. NOTE: Avoid using this method in user\-workflows and only in service\-to\-service workflows when the updates are already ordered by some other service/app.

### func \(ProtobufDataStore\) [UpdateWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L231>)

```go
func (p ProtobufDataStore) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Updates an existing Protobuf record in the DB. Returns, rowsAffected \- 0 if update fails; 1 otherwise md \- metadata of the updated Protobuf record err \- error that occurred during update, if any.

### func \(ProtobufDataStore\) [Upsert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L250>)

```go
func (p ProtobufDataStore) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Upsert Fetches metadata for the record and upserts the Protobuf message. NOTE: Avoid using this method in user\-workflows and only in service\-to\-service workflows when the updates are already ordered by some other service/app.

### func \(ProtobufDataStore\) [UpsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/pkg/protostore/protostore.go#L268-L270>)

```go
func (p ProtobufDataStore) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Upserts a Protobuf record in the DB \(if the record exists, it is updated; if it does not, it is inserted\). Returns, rowsAffected \- 0 if upsert fails; 1 otherwise md \- metadata of the upserted Protobuf record err \- error that occurred during upsert, if any.



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
