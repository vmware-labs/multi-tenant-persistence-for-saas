<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# datastore

```go
import "github.com/vmware-labs/multi-tenant-persistence-for-saas/data-access-layer/datastore"
```

## Index

- [Constants](<#constants>)
- [Variables](<#variables>)
- [func FromBytes(bytes []byte, message proto.Message) error](<#func-frombytes>)
- [func GetRlsPolicyName(username DbRole, tableName string) string](<#func-getrlspolicyname>)
- [func GetTableName(x interface{}) string](<#func-gettablename>)
- [func GetTableNameFromSlice(x interface{}) string](<#func-gettablenamefromslice>)
- [func IsMultitenant(x Record, tableNames ...string) bool](<#func-ismultitenant>)
- [func ToBytes(message proto.Message) ([]byte, error)](<#func-tobytes>)
- [type Authorizer](<#type-authorizer>)
- [type DataStoreHelper](<#type-datastorehelper>)
  - [func DatastoreHelperInDatabase() DataStoreHelper](<#func-datastorehelperindatabase>)
  - [func DatastoreHelperInMemory() DataStoreHelper](<#func-datastorehelperinmemory>)
- [type DataStoreTestHelper](<#type-datastoretesthelper>)
- [type DatabaseColumn](<#type-databasecolumn>)
- [type DbError](<#type-dberror>)
  - [func (e *DbError) Error() string](<#func-dberror-error>)
  - [func (e *DbError) Is(target error) bool](<#func-dberror-is>)
  - [func (e *DbError) Unwrap() error](<#func-dberror-unwrap>)
  - [func (e *DbError) With(msg string) *DbError](<#func-dberror-with>)
  - [func (e *DbError) WithContext(ctx context.Context) *DbError](<#func-dberror-withcontext>)
  - [func (e *DbError) WithMap(kvMap map[ErrorContextKey]string) *DbError](<#func-dberror-withmap>)
  - [func (e *DbError) WithValue(key ErrorContextKey, value string) *DbError](<#func-dberror-withvalue>)
  - [func (e *DbError) Wrap(err error) *DbError](<#func-dberror-wrap>)
- [type DbRole](<#type-dbrole>)
  - [func (dbRole DbRole) IsTenantDbRole() bool](<#func-dbrole-istenantdbrole>)
- [type DbRoleSlice](<#type-dbroleslice>)
  - [func (a DbRoleSlice) Len() int](<#func-dbroleslice-len>)
  - [func (a DbRoleSlice) Less(i, j int) bool](<#func-dbroleslice-less>)
  - [func (a DbRoleSlice) Swap(i, j int)](<#func-dbroleslice-swap>)
- [type ErrorContextKey](<#type-errorcontextkey>)
  - [func (c ErrorContextKey) String() string](<#func-errorcontextkey-string>)
- [type InMemory](<#type-inmemory>)
  - [func (inMemory *InMemory) Configure(_ context.Context, isDataStoreInMemory bool, authorizer Authorizer)](<#func-inmemory-configure>)
  - [func (inMemory *InMemory) Delete(ctx context.Context, record Record) (int64, error)](<#func-inmemory-delete>)
  - [func (inMemory *InMemory) DeleteInTable(ctx context.Context, cacheName string, record Record) (int64, error)](<#func-inmemory-deleteintable>)
  - [func (inMemory *InMemory) Drop(tableNames ...string) error](<#func-inmemory-drop>)
  - [func (inMemory *InMemory) DropTables(records ...Record) error](<#func-inmemory-droptables>)
  - [func (inMemory *InMemory) Find(ctx context.Context, record Record) error](<#func-inmemory-find>)
  - [func (inMemory *InMemory) FindAll(ctx context.Context, records interface{}) error](<#func-inmemory-findall>)
  - [func (inMemory *InMemory) FindAllInTable(ctx context.Context, cacheName string, records interface{}) error](<#func-inmemory-findallintable>)
  - [func (inMemory *InMemory) FindInTable(ctx context.Context, cacheName string, record Record) error](<#func-inmemory-findintable>)
  - [func (inMemory *InMemory) FindWithFilter(ctx context.Context, record Record, records interface{}) error](<#func-inmemory-findwithfilter>)
  - [func (inMemory *InMemory) FindWithFilterInTable(ctx context.Context, cacheName string, record Record, records interface{}) error](<#func-inmemory-findwithfilterintable>)
  - [func (inMemory *InMemory) GetAuthorizer() Authorizer](<#func-inmemory-getauthorizer>)
  - [func (inMemory *InMemory) Insert(ctx context.Context, record Record) (int64, error)](<#func-inmemory-insert>)
  - [func (inMemory *InMemory) InsertInTable(_ context.Context, cacheName string, record Record) (int64, error)](<#func-inmemory-insertintable>)
  - [func (inMemory *InMemory) PerformJoinOneToMany(ctx context.Context, record1 Record, record1Id string, record2JoinOnColumn string, query2Output interface{}) error](<#func-inmemory-performjoinonetomany>)
  - [func (inMemory *InMemory) PerformJoinOneToOne(ctx context.Context, record1 Record, record1Id string, record2 Record, record2JoinOnColumn string) error](<#func-inmemory-performjoinonetoone>)
  - [func (inMemory *InMemory) RegisterWithDAL(ctx context.Context, roleMapping map[string]DbRole, record Record) error](<#func-inmemory-registerwithdal>)
  - [func (inMemory *InMemory) RegisterWithDALHelper(_ context.Context, roleMapping map[string]DbRole, cacheName string, record Record) error](<#func-inmemory-registerwithdalhelper>)
  - [func (inMemory *InMemory) Reset()](<#func-inmemory-reset>)
  - [func (inMemory *InMemory) SetAuthorizer(authorizer Authorizer)](<#func-inmemory-setauthorizer>)
  - [func (inMemory *InMemory) Truncate(tableNames ...string) error](<#func-inmemory-truncate>)
  - [func (inMemory *InMemory) Update(ctx context.Context, record Record) (int64, error)](<#func-inmemory-update>)
  - [func (inMemory *InMemory) UpdateInTable(ctx context.Context, cacheName string, record Record) (int64, error)](<#func-inmemory-updateintable>)
  - [func (inMemory *InMemory) Upsert(ctx context.Context, record Record) (int64, error)](<#func-inmemory-upsert>)
  - [func (inMemory *InMemory) UpsertInTable(ctx context.Context, cacheName string, record Record) (int64, error)](<#func-inmemory-upsertintable>)
- [type Metadata](<#type-metadata>)
  - [func MetadataFrom(protoStoreMsg ProtoStoreMsg) Metadata](<#func-metadatafrom>)
- [type MetadataBasedAuthorizer](<#type-metadatabasedauthorizer>)
  - [func (s MetadataBasedAuthorizer) Configure(_ ...interface{})](<#func-metadatabasedauthorizer-configure>)
  - [func (s MetadataBasedAuthorizer) GetAuthContext(orgId string, roles ...string) context.Context](<#func-metadatabasedauthorizer-getauthcontext>)
  - [func (s MetadataBasedAuthorizer) GetDefaultOrgAdminContext() context.Context](<#func-metadatabasedauthorizer-getdefaultorgadmincontext>)
  - [func (s MetadataBasedAuthorizer) GetMatchingDbRole(ctx context.Context, tableNames ...string) (DbRole, error)](<#func-metadatabasedauthorizer-getmatchingdbrole>)
  - [func (s MetadataBasedAuthorizer) GetOrgFromContext(ctx context.Context) (string, error)](<#func-metadatabasedauthorizer-getorgfromcontext>)
  - [func (s MetadataBasedAuthorizer) IsOperationAllowed(ctx context.Context, tableName string, record Record) error](<#func-metadatabasedauthorizer-isoperationallowed>)
- [type ProtoStore](<#type-protostore>)
  - [func GetProtoStore() ProtoStore](<#func-getprotostore>)
- [type ProtoStoreMock](<#type-protostoremock>)
  - [func (p *ProtoStoreMock) Configure(ctx context.Context, isDataStoreInMemory bool, authorizer Authorizer)](<#func-protostoremock-configure>)
  - [func (p *ProtoStoreMock) DeleteById(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)](<#func-protostoremock-deletebyid>)
  - [func (p *ProtoStoreMock) DropTables(msgs ...proto.Message) error](<#func-protostoremock-droptables>)
  - [func (p *ProtoStoreMock) FindAll(ctx context.Context, msgs interface{}) (map[string]Metadata, error)](<#func-protostoremock-findall>)
  - [func (p *ProtoStoreMock) FindAllAsMap(ctx context.Context, msgsMap interface{}) (metadataMap map[string]Metadata, err error)](<#func-protostoremock-findallasmap>)
  - [func (p *ProtoStoreMock) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error](<#func-protostoremock-findbyid>)
  - [func (p *ProtoStoreMock) GetAuthorizer() Authorizer](<#func-protostoremock-getauthorizer>)
  - [func (p *ProtoStoreMock) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)](<#func-protostoremock-getmetadata>)
  - [func (p *ProtoStoreMock) GetRevision(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)](<#func-protostoremock-getrevision>)
  - [func (p *ProtoStoreMock) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protostoremock-insert>)
  - [func (p *ProtoStoreMock) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protostoremock-insertwithmetadata>)
  - [func (p *ProtoStoreMock) Register(ctx context.Context, roleMapping map[string]DbRole, msgs ...proto.Message) error](<#func-protostoremock-register>)
  - [func (p *ProtoStoreMock) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protostoremock-update>)
  - [func (p *ProtoStoreMock) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protostoremock-updatewithmetadata>)
  - [func (p *ProtoStoreMock) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protostoremock-upsert>)
  - [func (p *ProtoStoreMock) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protostoremock-upsertwithmetadata>)
- [type ProtoStoreMsg](<#type-protostoremsg>)
  - [func (protoStoreMsg ProtoStoreMsg) GetId() []interface{}](<#func-protostoremsg-getid>)
- [type ProtobufDataStore](<#type-protobufdatastore>)
  - [func (p ProtobufDataStore) Configure(ctx context.Context, isDataStoreInMemory bool, authorizer Authorizer)](<#func-protobufdatastore-configure>)
  - [func (p ProtobufDataStore) DeleteById(ctx context.Context, id string, msg proto.Message) (int64, error)](<#func-protobufdatastore-deletebyid>)
  - [func (p ProtobufDataStore) DropTables(msgs ...proto.Message) error](<#func-protobufdatastore-droptables>)
  - [func (p ProtobufDataStore) FindAll(ctx context.Context, msgs interface{}) (metadataMap map[string]Metadata, err error)](<#func-protobufdatastore-findall>)
  - [func (p ProtobufDataStore) FindAllAsMap(ctx context.Context, msgsMap interface{}) (metadataMap map[string]Metadata, err error)](<#func-protobufdatastore-findallasmap>)
  - [func (p ProtobufDataStore) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error](<#func-protobufdatastore-findbyid>)
  - [func (p ProtobufDataStore) GetAuthorizer() Authorizer](<#func-protobufdatastore-getauthorizer>)
  - [func (p ProtobufDataStore) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)](<#func-protobufdatastore-getmetadata>)
  - [func (p ProtobufDataStore) GetRevision(ctx context.Context, id string, msg proto.Message) (int64, error)](<#func-protobufdatastore-getrevision>)
  - [func (p ProtobufDataStore) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-insert>)
  - [func (p ProtobufDataStore) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-insertwithmetadata>)
  - [func (p ProtobufDataStore) Register(ctx context.Context, roleMapping map[string]DbRole, msgs ...proto.Message) error](<#func-protobufdatastore-register>)
  - [func (p ProtobufDataStore) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-update>)
  - [func (p ProtobufDataStore) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-updatewithmetadata>)
  - [func (p ProtobufDataStore) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-upsert>)
  - [func (p ProtobufDataStore) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)](<#func-protobufdatastore-upsertwithmetadata>)
- [type Record](<#type-record>)
  - [func GetRecordInstanceFromSlice(x interface{}) Record](<#func-getrecordinstancefromslice>)
- [type RelationalDb](<#type-relationaldb>)
  - [func (database *RelationalDb) Configure(_ context.Context, isDataStoreInMemory bool, authorizer Authorizer)](<#func-relationaldb-configure>)
  - [func (database *RelationalDb) Delete(ctx context.Context, record Record) (int64, error)](<#func-relationaldb-delete>)
  - [func (database *RelationalDb) DeleteInTable(ctx context.Context, tableName string, record Record) (int64, error)](<#func-relationaldb-deleteintable>)
  - [func (database *RelationalDb) Drop(tableNames ...string) error](<#func-relationaldb-drop>)
  - [func (database *RelationalDb) DropTables(records ...Record) error](<#func-relationaldb-droptables>)
  - [func (database *RelationalDb) Find(ctx context.Context, record Record) error](<#func-relationaldb-find>)
  - [func (database *RelationalDb) FindAll(ctx context.Context, records interface{}) error](<#func-relationaldb-findall>)
  - [func (database *RelationalDb) FindAllInTable(ctx context.Context, tableName string, records interface{}) error](<#func-relationaldb-findallintable>)
  - [func (database *RelationalDb) FindInTable(ctx context.Context, tableName string, record Record) error](<#func-relationaldb-findintable>)
  - [func (database *RelationalDb) FindWithFilter(ctx context.Context, record Record, records interface{}) error](<#func-relationaldb-findwithfilter>)
  - [func (database *RelationalDb) FindWithFilterInTable(ctx context.Context, tableName string, record Record, records interface{}) error](<#func-relationaldb-findwithfilterintable>)
  - [func (database *RelationalDb) GetAuthorizer() Authorizer](<#func-relationaldb-getauthorizer>)
  - [func (database *RelationalDb) Insert(ctx context.Context, record Record) (int64, error)](<#func-relationaldb-insert>)
  - [func (database *RelationalDb) InsertInTable(ctx context.Context, tableName string, record Record) (int64, error)](<#func-relationaldb-insertintable>)
  - [func (database *RelationalDb) PerformJoinOneToMany(ctx context.Context, record1 Record, record1Id string, record2JoinOnColumn string, query2Output interface{}) error](<#func-relationaldb-performjoinonetomany>)
  - [func (database *RelationalDb) PerformJoinOneToOne(ctx context.Context, record1 Record, record1Id string, record2 Record, record2JoinOnColumn string) error](<#func-relationaldb-performjoinonetoone>)
  - [func (database *RelationalDb) RegisterWithDAL(ctx context.Context, roleMapping map[string]DbRole, record Record) error](<#func-relationaldb-registerwithdal>)
  - [func (database *RelationalDb) RegisterWithDALHelper(_ context.Context, roleMapping map[string]DbRole, tableName string, record Record) error](<#func-relationaldb-registerwithdalhelper>)
  - [func (database *RelationalDb) Reset()](<#func-relationaldb-reset>)
  - [func (database *RelationalDb) Truncate(tableNames ...string) error](<#func-relationaldb-truncate>)
  - [func (database *RelationalDb) Update(ctx context.Context, record Record) (int64, error)](<#func-relationaldb-update>)
  - [func (database *RelationalDb) UpdateInTable(ctx context.Context, tableName string, record Record) (int64, error)](<#func-relationaldb-updateintable>)
  - [func (database *RelationalDb) Upsert(ctx context.Context, record Record) (int64, error)](<#func-relationaldb-upsert>)
  - [func (database *RelationalDb) UpsertInTable(ctx context.Context, tableName string, record Record) (int64, error)](<#func-relationaldb-upsertintable>)


## Constants

```go
const (
    METADATA_KEY_ORGID            = "orgid"
    METADATA_KEY_ROLE             = "role"
    METADATA_ROLE_SERVICE_ADMIN   = "service_admin"
    METADATA_ROLE_SERVICE_AUDITOR = "service_auditor"
    METADATA_ROLE_ADMIN           = "admin"   // can be tenant_admin, *_admin
    METADATA_ROLE_AUDITOR         = "auditor" // can be tenant_auditor, *_auditor
)
```

```go
const (
    // DB Runtime Parameters
    DB_CONFIG_ORG_ID = "multitenant.orgId" // Name of Postgres run-time config. parameter that will store current user's org. ID

    // DB Roles
    TENANT_READER DbRole = "tenant_reader"
    TENANT_WRITER DbRole = "tenant_writer"
    READER        DbRole = "reader"
    WRITER        DbRole = "writer"

    // Env. variable names
    DB_NAME_ENV_VAR           = "DB_NAME"
    DB_PORT_ENV_VAR           = "DB_PORT"
    DB_HOST_ENV_VAR           = "DB_HOST"
    SSL_MODE_ENV_VAR          = "SSL_MODE"
    DB_ADMIN_USERNAME_ENV_VAR = "DB_ADMIN_USERNAME"
    DB_ADMIN_PASSWORD_ENV_VAR = "DB_ADMIN_PASSWORD"
    LOGGER_LEVEL_ENV_VAR      = "LOG_LEVEL"
)
```

```go
const (
    ENV_VAR           = ErrorContextKey("EnvVar")
    DB_ADMIN_USERNAME = ErrorContextKey("dbAdminUsername")
    DB_HOST           = ErrorContextKey("dbHost")
    DB_NAME           = ErrorContextKey("dbName")
    DB_PORT           = ErrorContextKey("dbPort")
    DB_USERNAME       = ErrorContextKey("dbUsername")
    PORT_NUMBER       = ErrorContextKey("PortNumber")
    SQL_STMT          = ErrorContextKey("SqlStmt")
    SSL_MODE          = ErrorContextKey("sslMode")
    TABLE_NAME        = ErrorContextKey("TableName")
)
```

```go
const (
    // Golang Tags
    TAG_DB_COLUMN = "db_column"
    TAG_PRIMARY   = "primary_key"
    TAG_INDEX     = "db_index"

    // SQL Columns
    ORG_ID_COLUMN_NAME   = "org_id"
    REVISION_COLUMN_NAME = "_revision"

    // Messages
    REVISION_OUTDATED_MSG = "Invalid update - outdated "
)
```

```go
const GLOBAL_DEFAULT_ORG_ID = "_GlobalDefaultOrg"
```

## Variables

```go
var (
    BaseDbError                      = &DbError{}
    ErrorMissingRoleMapping          = BaseDbError.With("Missing role mapping for DB table")
    ErrorStructNotRegisteredWithDAL  = BaseDbError.With("Struct(s) have not been registered with DAL")
    IllegalArgumentError             = BaseDbError.With("Argument is invalid")
    InvalidPortNumberError           = BaseDbError.With("Port # is invalid")
    ErrorMissingEnvVar               = BaseDbError.With("An environment variable is missing or empty")
    ErrorMissingOrgId                = BaseDbError.With("Org. ID is missing in context")
    ErrorConnectingToDb              = BaseDbError.With("Failed to establish a connection with database")
    ErrorParsingSqlRow               = BaseDbError.With("Failed to parse a row from DB table")
    ErrorExecutingSqlStmt            = BaseDbError.With("SQL statement could not be executed")
    ErrorRegisteringWithDAL          = BaseDbError.With("Registration of a struct with DAL failed")
    ErrorStartingTx                  = BaseDbError.With("Failed to start a transaction")
    ErrorCommittingTx                = BaseDbError.With("Failed to commit a transaction")
    RevisionConflictError            = BaseDbError.With("Blocking update due to outdated revision")
    ErrorMarshalling                 = BaseDbError.With("Cannot marshal proto message to binary")
    ErrorUnmarshalling               = BaseDbError.With("Cannot unmarshal binary to proto message")
    ErrOperationNotAllowed           = BaseDbError.With("Not authorized to perform the operation on other tenant's data")
    ErrorFetchingMetadataFromContext = BaseDbError.With("Error fetching metadata from GRPC context")

    ErrAuthContext       = BaseDbError.With("Error extracting authContext from context")
    ErrNoAuthContext     = BaseDbError.With("Permission denied because authContext is missing")
    ErrNoUserContext     = BaseDbError.With("Permission denied because userInformation is missing")
    ErrUserNotAuthorized = BaseDbError.With("User is not authorized to access this API")
    ErrMissingOrgId      = BaseDbError.With("Org. ID is missing in context")
)
```

## func [FromBytes](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L111>)

```go
func FromBytes(bytes []byte, message proto.Message) error
```

## func [GetRlsPolicyName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/sql_struct.go#L396>)

```go
func GetRlsPolicyName(username DbRole, tableName string) string
```

Generates RLS\-policy name based on database role/user and table name

## func [GetTableName](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/sql_struct.go#L363>)

```go
func GetTableName(x interface{}) string
```

Extracts struct's name, which will serve as DB table name, using reflection.

## func [GetTableNameFromSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/sql_struct.go#L379>)

```go
func GetTableNameFromSlice(x interface{}) string
```

Extracts name of a struct comprising the input slice

## func [IsMultitenant](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/sql_struct.go#L81>)

```go
func IsMultitenant(x Record, tableNames ...string) bool
```

Checks if any of the tables in tableNames are multi\-tenant.

## func [ToBytes](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L119>)

```go
func ToBytes(message proto.Message) ([]byte, error)
```

## type [Authorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L33-L44>)

Interface for everything auth.\-related in DAL. Can be implemented by the users of DAL and passed to DAL using SetAuthorizer\(\).

```go
type Authorizer interface {
    GetDefaultOrgAdminContext() context.Context
    GetAuthContext(orgId string, roles ...string) context.Context
    GetOrgFromContext(ctx context.Context) (string, error)
    GetMatchingDbRole(ctx context.Context, tableNames ...string) (DbRole, error)
    IsOperationAllowed(ctx context.Context, tableName string, record Record) error

    /*
    	Method used to configure the authorizer. The method's arguments and implementation will be different for every authorizer.
    */
    Configure(args ...interface{})
}
```

## type [DataStoreHelper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/datastore.go#L45-L55>)

```go
type DataStoreHelper interface {
    GetAuthorizer() Authorizer
    Configure(ctx context.Context, isDataStoreInMemory bool, authorizer Authorizer)
    RegisterWithDALHelper(ctx context.Context, roleMapping map[string]DbRole, tableName string, record Record) error
    FindInTable(ctx context.Context, tableName string, record Record) error
    FindAllInTable(ctx context.Context, tableName string, records interface{}) error
    InsertInTable(ctx context.Context, tableName string, record Record) (int64, error)
    UpdateInTable(ctx context.Context, tableName string, record Record) (int64, error)
    UpsertInTable(ctx context.Context, tableName string, record Record) (int64, error)
    DeleteInTable(ctx context.Context, tableName string, record Record) (int64, error)
}
```

```go
var Helper DataStoreHelper = &relationalDb
```

### func [DatastoreHelperInDatabase](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/datastore.go#L92>)

```go
func DatastoreHelperInDatabase() DataStoreHelper
```

### func [DatastoreHelperInMemory](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/datastore.go#L86>)

```go
func DatastoreHelperInMemory() DataStoreHelper
```

## type [DataStoreTestHelper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/datastore.go#L57-L61>)

```go
type DataStoreTestHelper interface {
    DropTables(records ...Record) error  // Drop DB tables by records
    Drop(tableNames ...string) error     // Drops DB tables
    Truncate(tableNames ...string) error // Truncates DB tables
}
```

```go
var TestHelper DataStoreTestHelper = &relationalDb
```

## type [DatabaseColumn](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/sql_struct.go#L48-L53>)

```go
type DatabaseColumn struct {
    // contains filtered or unexported fields
}
```

## type [DbError](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L71-L75>)

```go
type DbError struct {
    // contains filtered or unexported fields
}
```

### func \(\*DbError\) [Error](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L77>)

```go
func (e *DbError) Error() string
```

### func \(\*DbError\) [Is](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L88>)

```go
func (e *DbError) Is(target error) bool
```

### func \(\*DbError\) [Unwrap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L96>)

```go
func (e *DbError) Unwrap() error
```

### func \(\*DbError\) [With](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L108>)

```go
func (e *DbError) With(msg string) *DbError
```

### func \(\*DbError\) [WithContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L116>)

```go
func (e *DbError) WithContext(ctx context.Context) *DbError
```

### func \(\*DbError\) [WithMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L140>)

```go
func (e *DbError) WithMap(kvMap map[ErrorContextKey]string) *DbError
```

### func \(\*DbError\) [WithValue](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L128>)

```go
func (e *DbError) WithValue(key ErrorContextKey, value string) *DbError
```

### func \(\*DbError\) [Wrap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L100>)

```go
func (e *DbError) Wrap(err error) *DbError
```

## type [DbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L51>)

Database roles/users

```go
type DbRole string
```

### func \(DbRole\) [IsTenantDbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L58>)

```go
func (dbRole DbRole) IsTenantDbRole() bool
```

## type [DbRoleSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L53>)

```go
type DbRoleSlice []DbRole // Needed for sorting records
```

### func \(DbRoleSlice\) [Len](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L54>)

```go
func (a DbRoleSlice) Len() int
```

### func \(DbRoleSlice\) [Less](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L70>)

```go
func (a DbRoleSlice) Less(i, j int) bool
```

Returns true if the first role has fewer permissions than the second role, and true if the two roles are the same or the second role has more permissions. A reader role is always considered to have fewer permissions than a writer role. and a tenant\-specific reader/writer role is always considered to have fewer permissions than a non\-tenant specific reader/writer role, respectively.

TENANT\_READER \< READER \< TENANT\_WRITER \< WRITER

### func \(DbRoleSlice\) [Swap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L86>)

```go
func (a DbRoleSlice) Swap(i, j int)
```

## type [ErrorContextKey](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L28>)

```go
type ErrorContextKey string
```

### func \(ErrorContextKey\) [String](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/error_codes.go#L124>)

```go
func (c ErrorContextKey) String() string
```

## type [InMemory](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L32-L37>)

Implementation of DataStore backed by an in\-memory cache. By default, uses MetadataBasedAuthorizer, which permits all operations on any tenant's data. This implementation does not have a notion of multi\-tenancy \- all the methods can access/modify all tenant's data.

```go
type InMemory struct {
    // contains filtered or unexported fields
}
```

### func \(\*InMemory\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L420>)

```go
func (inMemory *InMemory) Configure(_ context.Context, isDataStoreInMemory bool, authorizer Authorizer)
```

Configures data store to use Postgres or an in\-memory cache

### func \(\*InMemory\) [Delete](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L295>)

```go
func (inMemory *InMemory) Delete(ctx context.Context, record Record) (int64, error)
```

Deletes a record from cache. record must be a struct.

### func \(\*InMemory\) [DeleteInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L299>)

```go
func (inMemory *InMemory) DeleteInTable(ctx context.Context, cacheName string, record Record) (int64, error)
```

### func \(\*InMemory\) [Drop](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L337>)

```go
func (inMemory *InMemory) Drop(tableNames ...string) error
```

### func \(\*InMemory\) [DropTables](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L329>)

```go
func (inMemory *InMemory) DropTables(records ...Record) error
```

### func \(\*InMemory\) [Find](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L181>)

```go
func (inMemory *InMemory) Find(ctx context.Context, record Record) error
```

Finds a record that has the same primary key as record. record must be a pointer to a struct.

### func \(\*InMemory\) [FindAll](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L211>)

```go
func (inMemory *InMemory) FindAll(ctx context.Context, records interface{}) error
```

Finds all records of the requested type. record must be a pointer to a struct. records must be a pointer to a slice of structs.

### func \(\*InMemory\) [FindAllInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L223>)

```go
func (inMemory *InMemory) FindAllInTable(ctx context.Context, cacheName string, records interface{}) error
```

### func \(\*InMemory\) [FindInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L185>)

```go
func (inMemory *InMemory) FindInTable(ctx context.Context, cacheName string, record Record) error
```

### func \(\*InMemory\) [FindWithFilter](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L233>)

```go
func (inMemory *InMemory) FindWithFilter(ctx context.Context, record Record, records interface{}) error
```

Finds all records of the requested type. Does not do any filtering. record must be a pointer to a struct. records must be a pointer to a slice of structs.

### func \(\*InMemory\) [FindWithFilterInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L236>)

```go
func (inMemory *InMemory) FindWithFilterInTable(ctx context.Context, cacheName string, record Record, records interface{}) error
```

### func \(\*InMemory\) [GetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L52>)

```go
func (inMemory *InMemory) GetAuthorizer() Authorizer
```

### func \(\*InMemory\) [Insert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L272>)

```go
func (inMemory *InMemory) Insert(ctx context.Context, record Record) (int64, error)
```

Inserts a record into cache. record must be a struct.

### func \(\*InMemory\) [InsertInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L275>)

```go
func (inMemory *InMemory) InsertInTable(_ context.Context, cacheName string, record Record) (int64, error)
```

### func \(\*InMemory\) [PerformJoinOneToMany](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L133>)

```go
func (inMemory *InMemory) PerformJoinOneToMany(ctx context.Context, record1 Record, record1Id string, record2JoinOnColumn string, query2Output interface{}) error
```

Performs an inner join of in\-memory caches for records record1 and record2. Assumes the relationship between record1 and record2 is one\-to\-many. Stores the retrieved record from the first cache in record1 argument, and the matching records from the second cache in query2Output argument.

TODO \- if the first cache contains the record but the second one doesn't, don't return anything

### func \(\*InMemory\) [PerformJoinOneToOne](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L91>)

```go
func (inMemory *InMemory) PerformJoinOneToOne(ctx context.Context, record1 Record, record1Id string, record2 Record, record2JoinOnColumn string) error
```

Performs an inner join of in\-memory caches for records record1 and record2. Assumes the relationship between record1 and record2 is one\-to\-one. Stores the retrieved record from the first cache in record1 argument, and the matching records from the second cache in query2Output argument.

### func \(\*InMemory\) [RegisterWithDAL](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L406>)

```go
func (inMemory *InMemory) RegisterWithDAL(ctx context.Context, roleMapping map[string]DbRole, record Record) error
```

### func \(\*InMemory\) [RegisterWithDALHelper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L409>)

```go
func (inMemory *InMemory) RegisterWithDALHelper(_ context.Context, roleMapping map[string]DbRole, cacheName string, record Record) error
```

### func \(\*InMemory\) [Reset](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L59>)

```go
func (inMemory *InMemory) Reset()
```

Reset all the caches in memory and mutexes

### func \(\*InMemory\) [SetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L46>)

```go
func (inMemory *InMemory) SetAuthorizer(authorizer Authorizer)
```

### func \(\*InMemory\) [Truncate](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L345>)

```go
func (inMemory *InMemory) Truncate(tableNames ...string) error
```

Deletes all records from cache

### func \(\*InMemory\) [Update](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L359>)

```go
func (inMemory *InMemory) Update(ctx context.Context, record Record) (int64, error)
```

Updates a record in cache. record must be a struct.

### func \(\*InMemory\) [UpdateInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L363>)

```go
func (inMemory *InMemory) UpdateInTable(ctx context.Context, cacheName string, record Record) (int64, error)
```

### func \(\*InMemory\) [Upsert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L384>)

```go
func (inMemory *InMemory) Upsert(ctx context.Context, record Record) (int64, error)
```

### func \(\*InMemory\) [UpsertInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/inmemory.go#L388>)

```go
func (inMemory *InMemory) UpsertInTable(ctx context.Context, cacheName string, record Record) (int64, error)
```

## type [Metadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L94-L98>)

```go
type Metadata struct {
    Id       string
    ParentId string
    Revision int64
}
```

### func [MetadataFrom](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L127>)

```go
func MetadataFrom(protoStoreMsg ProtoStoreMsg) Metadata
```

## type [MetadataBasedAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L55-L56>)

```go
type MetadataBasedAuthorizer struct {
}
```

### func \(MetadataBasedAuthorizer\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L124>)

```go
func (s MetadataBasedAuthorizer) Configure(_ ...interface{})
```

### func \(MetadataBasedAuthorizer\) [GetAuthContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L128>)

```go
func (s MetadataBasedAuthorizer) GetAuthContext(orgId string, roles ...string) context.Context
```

### func \(MetadataBasedAuthorizer\) [GetDefaultOrgAdminContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L131>)

```go
func (s MetadataBasedAuthorizer) GetDefaultOrgAdminContext() context.Context
```

### func \(MetadataBasedAuthorizer\) [GetMatchingDbRole](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L74>)

```go
func (s MetadataBasedAuthorizer) GetMatchingDbRole(ctx context.Context, tableNames ...string) (DbRole, error)
```

### func \(MetadataBasedAuthorizer\) [GetOrgFromContext](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L58>)

```go
func (s MetadataBasedAuthorizer) GetOrgFromContext(ctx context.Context) (string, error)
```

### func \(MetadataBasedAuthorizer\) [IsOperationAllowed](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/authorizer.go#L98>)

```go
func (s MetadataBasedAuthorizer) IsOperationAllowed(ctx context.Context, tableName string, record Record) error
```

## type [ProtoStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L29-L92>)

```go
type ProtoStore interface {
    Register(ctx context.Context, roleMapping map[string]DbRole, msgs ...proto.Message) error
    Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
    FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
    FindAll(ctx context.Context, msgs interface{}) (metadataMap map[string]Metadata, err error)
    FindAllAsMap(ctx context.Context, msgsMap interface{}) (metadataMap map[string]Metadata, err error)
    DeleteById(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)

    /*
    	Inserts a new Protobuf record in the DB.
    	Input parameters:
    	ctx - Golang context to use
    	id - unique ID of the Protobuf record
    	msg - Protobuf record
    	metadata - metadata to use when inserting Protobuf record

    	Output parameters:
    	rowsAffected - 0 if insertion fails; 1 otherwise
    	md - metadata of the new Protobuf record
    	err - error that occurred during insertion, if any
    */
    InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)

    /*
    	Updates an existing Protobuf record in the DB.
    	Input parameters:
    	ctx - Golang context to use
    	id - unique ID of the Protobuf record
    	msg - Protobuf record
    	metadata - metadata to use when updating Protobuf record

    	Output parameters:
    	rowsAffected - 0 if update fails; 1 otherwise
    	md - metadata of the updated Protobuf record
    	err - error that occurred during update, if any

    */
    UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)

    /*
    	Upserts a Protobuf record in the DB (if the record exists, it is updated; if it does not, it is inserted).
    	Input parameters:
    	ctx - Golang context to use
    	id - unique ID of the Protobuf record
    	msg - Protobuf record
    	metadata - metadata to use when upserting Protobuf record

    	Output parameters:
    	rowsAffected - 0 if upsert fails; 1 otherwise
    	md - metadata of the upserted Protobuf record
    	err - error that occurred during upsert, if any

    */
    UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)

    GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
    GetRevision(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)

    Configure(ctx context.Context, isDataStoreInMemory bool, authorizer Authorizer)
    GetAuthorizer() Authorizer
    DropTables(msgs ...proto.Message) error
}
```

### func [GetProtoStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L142>)

```go
func GetProtoStore() ProtoStore
```

## type [ProtoStoreMock](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L31-L33>)

ProtoStore mock. Can be imported by micro\-services that need to mock ProtoStore.

```go
type ProtoStoreMock struct {
    mock.Mock
}
```

### func \(\*ProtoStoreMock\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L108>)

```go
func (p *ProtoStoreMock) Configure(ctx context.Context, isDataStoreInMemory bool, authorizer Authorizer)
```

### func \(\*ProtoStoreMock\) [DeleteById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L85>)

```go
func (p *ProtoStoreMock) DeleteById(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)
```

### func \(\*ProtoStoreMock\) [DropTables](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L60>)

```go
func (p *ProtoStoreMock) DropTables(msgs ...proto.Message) error
```

### func \(\*ProtoStoreMock\) [FindAll](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L80>)

```go
func (p *ProtoStoreMock) FindAll(ctx context.Context, msgs interface{}) (map[string]Metadata, error)
```

### func \(\*ProtoStoreMock\) [FindAllAsMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L45>)

```go
func (p *ProtoStoreMock) FindAllAsMap(ctx context.Context, msgsMap interface{}) (metadataMap map[string]Metadata, err error)
```

### func \(\*ProtoStoreMock\) [FindById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L75>)

```go
func (p *ProtoStoreMock) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
```

### func \(\*ProtoStoreMock\) [GetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L112>)

```go
func (p *ProtoStoreMock) GetAuthorizer() Authorizer
```

### func \(\*ProtoStoreMock\) [GetMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L50>)

```go
func (p *ProtoStoreMock) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
```

### func \(\*ProtoStoreMock\) [GetRevision](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L55>)

```go
func (p *ProtoStoreMock) GetRevision(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, err error)
```

### func \(\*ProtoStoreMock\) [Insert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L70>)

```go
func (p *ProtoStoreMock) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

### func \(\*ProtoStoreMock\) [InsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L90-L91>)

```go
func (p *ProtoStoreMock) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

### func \(\*ProtoStoreMock\) [Register](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L65>)

```go
func (p *ProtoStoreMock) Register(ctx context.Context, roleMapping map[string]DbRole, msgs ...proto.Message) error
```

### func \(\*ProtoStoreMock\) [Update](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L35>)

```go
func (p *ProtoStoreMock) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

### func \(\*ProtoStoreMock\) [UpdateWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L96-L97>)

```go
func (p *ProtoStoreMock) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

### func \(\*ProtoStoreMock\) [Upsert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L40>)

```go
func (p *ProtoStoreMock) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

### func \(\*ProtoStoreMock\) [UpsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore_mock.go#L102-L103>)

```go
func (p *ProtoStoreMock) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

## type [ProtoStoreMsg](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L99-L105>)

```go
type ProtoStoreMsg struct {
    Id       string `db_column:"id" primary_key:"true"`
    Msg      []byte `db_column:"msg"`
    ParentId string `db_column:"_parent_id"`
    Revision int64  `db_column:"_revision"`
    OrgId    string `db_column:"org_id"`
}
```

### func \(ProtoStoreMsg\) [GetId](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L107>)

```go
func (protoStoreMsg ProtoStoreMsg) GetId() []interface{}
```

## type [ProtobufDataStore](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L135-L136>)

```go
type ProtobufDataStore struct {
}
```

### func \(ProtobufDataStore\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L146>)

```go
func (p ProtobufDataStore) Configure(ctx context.Context, isDataStoreInMemory bool, authorizer Authorizer)
```

### func \(ProtobufDataStore\) [DeleteById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L462>)

```go
func (p ProtobufDataStore) DeleteById(ctx context.Context, id string, msg proto.Message) (int64, error)
```

### func \(ProtobufDataStore\) [DropTables](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L475>)

```go
func (p ProtobufDataStore) DropTables(msgs ...proto.Message) error
```

### func \(ProtobufDataStore\) [FindAll](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L411>)

```go
func (p ProtobufDataStore) FindAll(ctx context.Context, msgs interface{}) (metadataMap map[string]Metadata, err error)
```

Finds all messages \(of the same type as the element of msgs\) in Protostore and stores the result in msgs. msgs must be a pointer to a slice of Protobuf structs or a pointer to a slice of pointers to Protobuf structs. It will be modified in\-place. Returns a map of Protobuf messages' IDs to their metadata \(parent ID & revision\).

### func \(ProtobufDataStore\) [FindAllAsMap](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L347>)

```go
func (p ProtobufDataStore) FindAllAsMap(ctx context.Context, msgsMap interface{}) (metadataMap map[string]Metadata, err error)
```

### func \(ProtobufDataStore\) [FindById](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L302>)

```go
func (p ProtobufDataStore) FindById(ctx context.Context, id string, msg proto.Message, metadata *Metadata) error
```

Finds a Protobuf message by ID. If metadata arg. is non\-nil, fills it with the metadata \(parent ID & revision\) of the Protobuf message that was found.

### func \(ProtobufDataStore\) [GetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L138>)

```go
func (p ProtobufDataStore) GetAuthorizer() Authorizer
```

### func \(ProtobufDataStore\) [GetMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L323>)

```go
func (p ProtobufDataStore) GetMetadata(ctx context.Context, id string, msg proto.Message) (md Metadata, err error)
```

### func \(ProtobufDataStore\) [GetRevision](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L338>)

```go
func (p ProtobufDataStore) GetRevision(ctx context.Context, id string, msg proto.Message) (int64, error)
```

### func \(ProtobufDataStore\) [Insert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L164>)

```go
func (p ProtobufDataStore) Insert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Inserts a Protobuf message with the given id and belonging to the given org. into data store

### func \(ProtobufDataStore\) [InsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L168>)

```go
func (p ProtobufDataStore) InsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

### func \(ProtobufDataStore\) [Register](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L150>)

```go
func (p ProtobufDataStore) Register(ctx context.Context, roleMapping map[string]DbRole, msgs ...proto.Message) error
```

### func \(ProtobufDataStore\) [Update](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L207>)

```go
func (p ProtobufDataStore) Update(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Fetches metadata for the record and updates the Protobuf message. NOTE: Avoid using this method in user\-workflows and only in service\-to\-service workflows when the updates are already ordered by some other service/app

### func \(ProtobufDataStore\) [UpdateWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L218>)

```go
func (p ProtobufDataStore) UpdateWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

Updates a Protobuf message

### func \(ProtobufDataStore\) [Upsert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L252>)

```go
func (p ProtobufDataStore) Upsert(ctx context.Context, id string, msg proto.Message) (rowsAffected int64, md Metadata, err error)
```

Fetches metadata for the record and upserts the Protobuf message. NOTE: Avoid using this method in user\-workflows and only in service\-to\-service workflows when the updates are already ordered by some other service/app

### func \(ProtobufDataStore\) [UpsertWithMetadata](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/protostore.go#L265-L266>)

```go
func (p ProtobufDataStore) UpsertWithMetadata(ctx context.Context, id string, msg proto.Message, metadata Metadata) (rowsAffected int64, md Metadata, err error)
```

## type [Record](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/record.go#L23-L29>)

```go
type Record interface {
    /*
    	Returns all the fields that can together uniquely identify the record (primary key). The fields returned in the slice
    	must be in the same order as they were declared in the struct.
    */
    GetId() []interface{}
}
```

### func [GetRecordInstanceFromSlice](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/record.go#L31>)

```go
func GetRecordInstanceFromSlice(x interface{}) Record
```

## type [RelationalDb](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L123-L126>)

Postgres\-backed implementation of DataStore interface. By default, uses MetadataBasedAuthorizer for authentication & authorization.

```go
type RelationalDb struct {
    // contains filtered or unexported fields
}
```

### func \(\*RelationalDb\) [Configure](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L1057>)

```go
func (database *RelationalDb) Configure(_ context.Context, isDataStoreInMemory bool, authorizer Authorizer)
```

Configures data store to use Postgres or an in\-memory cache. Should be called when microservice starts up.

### func \(\*RelationalDb\) [Delete](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L662>)

```go
func (database *RelationalDb) Delete(ctx context.Context, record Record) (int64, error)
```

Deletes a record from a DB table

### func \(\*RelationalDb\) [DeleteInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L743>)

```go
func (database *RelationalDb) DeleteInTable(ctx context.Context, tableName string, record Record) (int64, error)
```

Deletes a record from DB table tableName

### func \(\*RelationalDb\) [Drop](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L695>)

```go
func (database *RelationalDb) Drop(tableNames ...string) error
```

Drops given DB tables.

### func \(\*RelationalDb\) [DropTables](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L669>)

```go
func (database *RelationalDb) DropTables(records ...Record) error
```

\* Drops the DB tables given by Records

### func \(\*RelationalDb\) [Find](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L463>)

```go
func (database *RelationalDb) Find(ctx context.Context, record Record) error
```

Finds a single record that has the same primary key as record. record argument must be a pointer to a struct and will be modified in\-place.

### func \(\*RelationalDb\) [FindAll](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L524>)

```go
func (database *RelationalDb) FindAll(ctx context.Context, records interface{}) error
```

Finds all records in a DB table. records must be a pointer to a slice of structs and will be modified in\-place.

### func \(\*RelationalDb\) [FindAllInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L540>)

```go
func (database *RelationalDb) FindAllInTable(ctx context.Context, tableName string, records interface{}) error
```

Finds all records in DB table tableName. records must be a pointer to a slice of structs and will be modified in\-place.

### func \(\*RelationalDb\) [FindInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L471>)

```go
func (database *RelationalDb) FindInTable(ctx context.Context, tableName string, record Record) error
```

Finds a single record in table tableName that has the same primary key as record. record argument must be a pointer to a struct and will be modified in\-place.

### func \(\*RelationalDb\) [FindWithFilter](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L554>)

```go
func (database *RelationalDb) FindWithFilter(ctx context.Context, record Record, records interface{}) error
```

Finds multiple records in a DB table. If record argument is non\-empty, uses the non\-empty fields as criteria in a query. records must be a pointer to a slice of structs and will be modified in\-place.

### func \(\*RelationalDb\) [FindWithFilterInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L563>)

```go
func (database *RelationalDb) FindWithFilterInTable(ctx context.Context, tableName string, record Record, records interface{}) error
```

Finds multiple records in DB table tableName. If record argument is non\-empty, uses the non\-empty fields as criteria in a query. records must be a pointer to a slice of structs and will be modified in\-place.

### func \(\*RelationalDb\) [GetAuthorizer](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L1050>)

```go
func (database *RelationalDb) GetAuthorizer() Authorizer
```

### func \(\*RelationalDb\) [Insert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L619>)

```go
func (database *RelationalDb) Insert(ctx context.Context, record Record) (int64, error)
```

Inserts a record into a DB table

### func \(\*RelationalDb\) [InsertInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L626>)

```go
func (database *RelationalDb) InsertInTable(ctx context.Context, tableName string, record Record) (int64, error)
```

Inserts a record into DB table tableName.

### func \(\*RelationalDb\) [PerformJoinOneToMany](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L395>)

```go
func (database *RelationalDb) PerformJoinOneToMany(ctx context.Context, record1 Record, record1Id string, record2JoinOnColumn string, query2Output interface{}) error
```

Performs an inner join between 2 non\-multitenant DB tables, joining them on the key column of the first table and the "record2JoinOnField" column of the 2nd table. Assumes the following: \- There is a one\-to\-many relationship between the two tables \- Both tables either have primary keys consisting of one column \(ID\) or a composite key that is a combination of record ID and org. ID Requires a unique ID of the record in the first table to be passed, which leads to 1 record from the first table and multiple records from the second table to be returned. record1 must be a pointer to a struct implementing Record interface. query2Output must be a pointer to an array of structs implementing Record interface. record1 and query2Output will be filled with data retrieved from the 2 DB tables.

### func \(\*RelationalDb\) [PerformJoinOneToOne](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L326>)

```go
func (database *RelationalDb) PerformJoinOneToOne(ctx context.Context, record1 Record, record1Id string, record2 Record, record2JoinOnColumn string) error
```

Performs an inner join between 2 non\-multitenant DB tables, joining them on the key column of the first table and the "record2JoinOnField" column of the 2nd table. Assumes the following: \- There is a one\-to\-one relationship between the two tables \- Both tables either have primary keys consisting of one column \(ID\) or a composite key that is a combination of record ID and org. ID Requires a unique ID of the record in the first table to be passed, which leads to only one record to be returned. record1 and record2 must be pointers to structs implementing Record interface and represent entities persisted to the 2 DB tables. record1 and record2 will be filled with data retrieved from the 2 DB tables. TODO return ErrOperationNotAllowed if the library user is trying to access other tenant's data

### func \(\*RelationalDb\) [RegisterWithDAL](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L869>)

```go
func (database *RelationalDb) RegisterWithDAL(ctx context.Context, roleMapping map[string]DbRole, record Record) error
```

Registers a struct with DAL. See RegisterWithDALHelper\(\) for more info.

### func \(\*RelationalDb\) [RegisterWithDALHelper](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L889>)

```go
func (database *RelationalDb) RegisterWithDALHelper(_ context.Context, roleMapping map[string]DbRole, tableName string, record Record) error
```

Create a DB table for the given struct. Enables RLS in it if it is multi\-tenant. Generates Postgres roles and policies based on the provided role mapping and applies them to the created DB table. roleMapping \- maps service roles to DB roles to be used for the generated DB table There are 4 possible DB roles to choose from: \- READER, which gives read access to all the records in the table \- WRITER\*, which gives read & write access to all the records in the table \- TENANT\_READER, which gives read access to current tenant's records \- TENANT\_WRITER, which gives read & write access to current tenant's records

Panics if the struct doesn't pass the following validations: \- Each field has to have a tag indicating the name of the relevant column in DB table \- Each field has to be exported \- Each field has to be of a supported data type \(signed integral data types, boolean, strings\)

### func \(\*RelationalDb\) [Reset](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L301>)

```go
func (database *RelationalDb) Reset()
```

Resets DB connection pools

### func \(\*RelationalDb\) [Truncate](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L717>)

```go
func (database *RelationalDb) Truncate(tableNames ...string) error
```

### func \(\*RelationalDb\) [Update](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L779>)

```go
func (database *RelationalDb) Update(ctx context.Context, record Record) (int64, error)
```

Updates a record in a DB table

### func \(\*RelationalDb\) [UpdateInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L786>)

```go
func (database *RelationalDb) UpdateInTable(ctx context.Context, tableName string, record Record) (int64, error)
```

Updates a record in DB table tableName

### func \(\*RelationalDb\) [Upsert](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L825>)

```go
func (database *RelationalDb) Upsert(ctx context.Context, record Record) (int64, error)
```

Upserts a record in a DB table

### func \(\*RelationalDb\) [UpsertInTable](<https://github.com/vmware-labs/multi-tenant-persistence-for-saas/blob/main/data-access-layer/datastore/database.go#L832>)

```go
func (database *RelationalDb) UpsertInTable(ctx context.Context, tableName string, record Record) (int64, error)
```

Upserts a record in DB table tableName



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
